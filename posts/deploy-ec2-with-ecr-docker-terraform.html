<!DOCTYPE html><html><head><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-CZ0TSM98BL"></script><script>
									window.dataLayer = window.dataLayer || [];
									function gtag(){dataLayer.push(arguments)}
									gtag('js', new Date());
	
									gtag('config', 'G-CZ0TSM98BL');
							</script><meta charSet="utf-8"/><title>Deploy Docker-ized React/Node.js on EC2 via Terraform by Suhan Wijaya</title><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="title" content="Deploy Docker-ized React/Node.js on EC2 via Terraform by Suhan Wijaya"/><meta name="description" content="Avoid ClickOps by using Terraform to push Docker images to ECR and run a container on EC2"/><meta property="og:type" content="website"/><meta property="og:url" content="https://www.suhanwijaya.com/posts/deploy-ec2-with-ecr-docker-terraform"/><meta property="og:title" content="Deploy Docker-ized React/Node.js on EC2 via Terraform by Suhan Wijaya"/><meta property="og:description" content="Avoid ClickOps by using Terraform to push Docker images to ECR and run a container on EC2"/><meta property="og:image" content="https://www.suhanwijaya.com/images/deploy-ec2-with-ecr-docker-terraform/final-preview.gif"/><meta name="twitter:title" content="Deploy Docker-ized React/Node.js on EC2 via Terraform by Suhan Wijaya"/><meta name="twitter:description" content="Avoid ClickOps by using Terraform to push Docker images to ECR and run a container on EC2"/><meta name="twitter:image" content="https://www.suhanwijaya.com/images/deploy-ec2-with-ecr-docker-terraform/final-preview.gif"/><meta name="twitter:card" content="summary_large_image"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism-okaidia.min.css" integrity="sha512-mIs9kKbaw6JZFfSuo+MovjU+Ntggfoj8RwAmJbVXQ5mkAX5LlgETQEweFPI18humSPHymTb5iikEOKWF7I8ncQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><meta name="next-head-count" content="15"/><link rel="preload" href="/_next/static/css/styles.5af1d3c5.chunk.css" as="style"/><link rel="stylesheet" href="/_next/static/css/styles.5af1d3c5.chunk.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-5e53dfd826fb0870df0c.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-147ea3ada7109f6dc0bb.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.abffcf18e526b7c0dbcd.js" as="script"/><link rel="preload" href="/_next/static/chunks/c8817c810ac732b2202d2ab097cea034b8097b3b.0aef9695673ee5c17c2c.js" as="script"/><link rel="preload" href="/_next/static/chunks/styles.9f8778bb7b15c3d6357d.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-bc363205d93151ffb13d.js" as="script"/><link rel="preload" href="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.56ff6c4147bf7f56cf0b.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-d0a1dfafc99629a40584.js" as="script"/></head><body><div id="__next"><div class="layout_GvkLX"><nav class="menu_2G6rj"><h2 class="name_10dbC">suhan <br/>wijaya</h2><ul class="menuItems_26ie3"><li class="menuItem_5m-L2"><a href="/#intro">INTRO</a></li><li class="menuItem_5m-L2"><a href="/#about">ABOUT</a></li><li class="menuItem_5m-L2"><a href="/#blog">BLOG</a></li><li class="menuItem_5m-L2"><a href="/#projects">PROJECTS</a></li><li class="menuItem_5m-L2"><a href="/#contact">CONTACT</a></li><li class="menuItem_5m-L2"><a href="/#toolbox">TOOLBOX</a></li></ul><a href="mailto:suhanw@gmail.com" target="_blank" class="email_3kN3h">suhanw@gmail.com</a><div class="social_3_hb2"><a href="https://www.linkedin.com/comm/in/suhanwijaya/" target="_blank"><img src="/images/linked-in.png" alt="Suhan&#x27;s LinkedIn profile"/></a><a href="https://x.com/suhanw" target="_blank"><img src="/images/twitter-x.png" alt="Suhan&#x27;s Twitter profile"/></a><a href="https://github.com/suhanw" target="_blank"><img src="/images/github.png" alt="Suhan&#x27;s GitHub profile"/></a></div><ul class="topMenuItems_3Vx-y"><li class="menuItem_5m-L2"><a href="/#blog">BACK TO HOME</a></li></ul></nav><button class="hamburger_1KX_H"><img src="/images/hamburger.png"/></button><article class="contentWrapper_1Wy1l"><h1 class="title_29RlI">Deploy Docker-ized React/Node.js on EC2 via Terraform</h1><div class="description_1Da_c">Avoid ClickOps by using Terraform to push Docker images to ECR and run a container on EC2</div><div class="date_2avFh"><time dateTime="2024-04-25">Apr 25, 2024</time><span class="socialIcons_2XzlR"><a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://www.suhanwijaya.com/posts/deploy-ec2-with-ecr-docker-terraform" target="_blank" aria-label="Share this article on LinkedIn"><img src="/images/linkedin-share.png"/></a><a href="https://x.com/intent/tweet?text=Deploy Docker-ized React/Node.js on EC2 via Terraform by Suhan Wijaya%20@suhanw%20https://www.suhanwijaya.com/posts/deploy-ec2-with-ecr-docker-terraform" target="_blank" aria-label="Share this article on Twitter"><img src="/images/twitter-x-share.png"/></a></span></div><div class="content_33yU5"><p>Terraform, Docker, and AWS are pivotal tools in modern software practices, enabling developers to streamline the process of deploying, managing, and scaling applications in the cloud. Here are notes from my journey in exploring the basics of Terraform, Docker, and AWS, and understanding how they work together.</p>
<hr>
<h3>Big picture</h3>
<p>We will accomplish these steps:</p>
<ol>
<li>Build and package our web app into a Docker image.</li>
<li>Push the Docker image to AWS Elastic Container Registry (ECR) which is a Docker container registry for storing container images.</li>
<li>Deploy an AWS Elastic Compute Cloud (EC2) instance that pulls the latest Docker image of our web app from ECR and starts our containerized web app.</li>
</ol>
<hr>
<h3>Prerequisites</h3>
<p>Before we start, ensure you have the following:</p>
<ul>
<li>Install <a href="https://docs.docker.com/desktop/install/mac-install/">Docker</a> and <a href="https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli">Terraform</a> on your local machine.</li>
<li>Create an AWS <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/getting-set-up.html#create-an-admin">Identity and Access Management (IAM) user with Admin access</a>.</li>
<li>Generate a <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html#Using_CreateAccessKey">secret access key</a> for your IAM admin user to enable Terraform to interact with AWS.</li>
<li>Generate an <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/create-key-pairs.html">EC2 key pair</a> to enable you to SSH into the EC2 instance.</li>
</ul>
<p>All done? Here we go!</p>
<hr>
<h3>Step 1 - Build and package our web app into a Docker image</h3>
<figure>
    <img src="/images/deploy-ec2-with-ecr-docker-terraform/cover.jpg">
</figure>
<p>We will be using the React/Node.js app from this <a href="https://www.suhanwijaya.com/posts/react-node-typescript-2024">previous blog post</a>.</p>
<p>Run the command <code class="language-unknown">docker init</code> , answer several questions, to create a templated Dockerfile in the project root directory as a starting point.</p>
<p>The following Dockerfile was updated from the initial template, and it serves as a set of instructions to containerize our web app. It starts with an Alpine-based Node.js image and includes several steps to install dependencies, build the application, and set up the environment for production use:</p>
<div class="remark-highlight"><pre class="language-docker"><code class="language-docker"><span class="token comment"># Dockerfile</span>
<span class="token comment"># syntax=docker/dockerfile:1</span>

<span class="token instruction"><span class="token keyword">ARG</span> NODE_VERSION=20.12.2</span>
<span class="token instruction"><span class="token keyword">FROM</span> node:<span class="token variable">${NODE_VERSION}</span>-alpine</span>

<span class="token instruction"><span class="token keyword">ENV</span> NODE_ENV production</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /usr/src/app</span>

<span class="token comment"># [A]</span>
<span class="token instruction"><span class="token keyword">RUN</span> <span class="token options"><span class="token property">--mount</span><span class="token punctuation">=</span><span class="token string">type=bind,source=package.json,target=package.json</span> <span class="token operator">\</span>
    <span class="token property">--mount</span><span class="token punctuation">=</span><span class="token string">type=bind,source=package-lock.json,target=package-lock.json</span> <span class="token operator">\</span>
    <span class="token property">--mount</span><span class="token punctuation">=</span><span class="token string">type=cache,target=/root/.npm</span></span> <span class="token operator">\</span>
    npm ci --include=dev</span>

<span class="token comment"># [B]</span>
<span class="token instruction"><span class="token keyword">COPY</span> . .</span>

<span class="token comment"># [C]</span>
<span class="token instruction"><span class="token keyword">RUN</span> npm run build</span>

<span class="token comment"># [D]</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 3000</span>
<span class="token instruction"><span class="token keyword">USER</span> node</span>
<span class="token instruction"><span class="token keyword">CMD</span> npm run start</span>
</code></pre></div>
<p>Annotations of the code comments above:<br>
<strong>[A]</strong> Install dependencies using <code class="language-unknown">npm ci</code> to ensure consistent builds and utilize cache mounts to improve build speed.<br>
<strong>[B]</strong> Copy the dependencies into the <a href="https://docs.docker.com/reference/dockerfile/#workdir">WORKDIR</a> to build and start our web app.<br>
<strong>[C]</strong> Build the app!<br>
<strong>[D]</strong> Expose port 3000 for incoming traffic, start the app as a non-root user for security reasons, and our app will now listen on port 3000 for connections.</p>
<p>To build this Docker image locally:</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">docker build <span class="token builtin class-name">.</span> -t my-app
</code></pre></div>
<p>To run the image as a container:</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">docker run -it -p <span class="token number">3000</span>:3000 my-app:latest
</code></pre></div>
<p>The <code class="language-unknown">-p 3000:3000</code> option <a href="https://docs.docker.com/network/#published-ports">publishes a port</a> on the Docker host (the port accessible to the outside world) that maps to the container port (the port our Dockerfile exposes).</p>
<hr>
<h3>Step 2 - Push the Docker image to ECR</h3>
<figure>
    <img src="/images/deploy-ec2-with-ecr-docker-terraform/docker-ecr.gif">
</figure>
<p>Now’s the time to introduce Terraform, an infrastructure-as-code (IaC) tool to define cloud resources and manage their lifecycle. It supports various cloud providers, including AWS, enabling developers to automate infrastructure provisioning, scaling, and teardown. Terraform's declarative syntax makes it easy to describe the desired infrastructure state, and its modular structure allows for reusable code and collaboration.</p>
<p>Before we delve into Terraform code, let’s first set <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html#Using_CreateAccessKey">our secret access key</a> (see prerequisites) as environment variables to enable Terraform to interact with AWS when we run <code class="language-unknown">terraform</code> commands. Store these keys securely, avoid sharing them publicly. I opted to save them in a gitignored <code class="language-unknown">.env</code> file.</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token comment"># .env</span>

<span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_ACCESS_KEY_ID</span><span class="token operator">=</span>your-access-key-id
<span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_SECRET_ACCESS_KEY</span><span class="token operator">=</span>your-secret-access-key
</code></pre></div>
<p>Run this command in the project root directory before running any <code class="language-unknown">terraform</code> command:</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">source</span> .env

<span class="token comment"># confirm that the env variable has been exported</span>
<span class="token builtin class-name">echo</span> <span class="token variable">$AWS_SECRET_ACCESS_KEY</span>
</code></pre></div>
<p>Now we’re ready to write some code. Terraform code lives in <code class="language-unknown">.tf</code> config files. For the sake of illustration, I’ll be using just a single <code class="language-unknown">main.tf</code> config file in the project root.</p>
<p>Let’s unpack the file in small chunks.</p>
<hr>
<h4>Provider configuration</h4>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token comment"># main.tf</span>

<span class="token comment"># [A]</span>
terraform <span class="token punctuation">{</span>
  required_providers <span class="token punctuation">{</span>
    aws <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token builtin class-name">source</span>  <span class="token operator">=</span> <span class="token string">"hashicorp/aws"</span>
      version <span class="token operator">=</span> <span class="token string">"~> 5.0"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># [B] AWS region variable</span>
variable <span class="token string">"aws_region"</span> <span class="token punctuation">{</span>
  description <span class="token operator">=</span> <span class="token string">"AWS region"</span>
  <span class="token builtin class-name">type</span>        <span class="token operator">=</span> string
  default     <span class="token operator">=</span> <span class="token string">"us-east-1"</span>
<span class="token punctuation">}</span>

<span class="token comment"># [B] AWS Provider configuration</span>
provider <span class="token string">"aws"</span> <span class="token punctuation">{</span> <span class="token comment"># [B]</span>
  region <span class="token operator">=</span> var.aws_region
<span class="token punctuation">}</span>

<span class="token comment"># [C] Data sources for AWS account and VPC</span>
data <span class="token string">"aws_caller_identity"</span> <span class="token string">"current"</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
data <span class="token string">"aws_vpc"</span> <span class="token string">"default"</span> <span class="token punctuation">{</span>
  default <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token comment"># [C] Local variables for common information</span>
locals <span class="token punctuation">{</span>
  account_id     <span class="token operator">=</span> data.aws_caller_identity.current.account_id
  default_vpc_id <span class="token operator">=</span> data.aws_vpc.default.id
  common_tags <span class="token operator">=</span> <span class="token punctuation">{</span>
    project <span class="token operator">=</span> <span class="token string">"blog-terraform-docker"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>Annotations of the code comments above:<br>
<strong>[A]</strong> <a href="https://developer.hashicorp.com/terraform/language/providers/configuration?utm_source=tf_registry&#x26;utm_content=sidebar">Providers</a> allow Terraform to interact with cloud providers, SaaS providers, and other APIs. Therefore, Terraform configs must declare which providers they require so that Terraform can install and use them. In our case, we are declaring the AWS provider.<br>
<strong>[B]</strong> Specify the AWS region in which we’d like to provision our resources.<br>
<strong>[C]</strong> <a href="https://developer.hashicorp.com/terraform/language/data-sources">Data sources</a> allow Terraform to use information defined outside of Terraform, and each cloud provider, including AWS, offers data sources that can be used in our configs. In this case, we will be using our AWS account ID as well the <a href="https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html">VPC</a> ID that’s provisioned by default when we signed up for the AWS account. These are saved to <a href="https://developer.hashicorp.com/terraform/language/values/locals">local values</a> to be used downstream in the rest of our code.</p>
<hr>
<h4>Provision an ECR repository to store our Docker images</h4>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token comment"># [A] Create an ECR repository</span>
resource <span class="token string">"aws_ecr_repository"</span> <span class="token string">"blog_terraform_docker"</span> <span class="token punctuation">{</span>
  name <span class="token operator">=</span> <span class="token string">"blog-terraform-docker"</span>
  image_scanning_configuration <span class="token punctuation">{</span>
    scan_on_push <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
  tags <span class="token operator">=</span> local.common_tags
<span class="token punctuation">}</span>

<span class="token comment"># [A] ECR lifecycle policy to retain only one untagged image preceding the latest</span>
resource <span class="token string">"aws_ecr_lifecycle_policy"</span> <span class="token string">"blog_terraform_docker"</span> <span class="token punctuation">{</span>
  repository <span class="token operator">=</span> aws_ecr_repository.blog_terraform_docker.name
  policy <span class="token operator">=</span> <span class="token operator">&#x3C;&#x3C;</span>EOF
    <span class="token punctuation">{</span>
      <span class="token string">"rules"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string">"rulePriority"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
          <span class="token string">"description"</span><span class="token builtin class-name">:</span> <span class="token string">"Keep only one untagged image that precedes the latest image"</span>,
          <span class="token string">"selection"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">"tagStatus"</span><span class="token builtin class-name">:</span> <span class="token string">"untagged"</span>,
            <span class="token string">"countType"</span><span class="token builtin class-name">:</span> <span class="token string">"imageCountMoreThan"</span>,
            <span class="token string">"countNumber"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>
          <span class="token punctuation">}</span>,
          <span class="token string">"action"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"expire"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    EOF
<span class="token punctuation">}</span>

<span class="token comment"># [B] Build Docker image and push to ECR repository</span>
resource <span class="token string">"terraform_data"</span> <span class="token string">"docker_build"</span> <span class="token punctuation">{</span>
  depends_on <span class="token operator">=</span> <span class="token punctuation">[</span>aws_ecr_repository.blog_terraform_docker<span class="token punctuation">]</span>

  <span class="token comment"># To make sure the local-exec runs every time</span>
  triggers_replace <span class="token operator">=</span> <span class="token punctuation">[</span>timestamp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

  provisioner <span class="token string">"local-exec"</span> <span class="token punctuation">{</span>
    <span class="token builtin class-name">command</span> <span class="token operator">=</span> <span class="token operator">&#x3C;&#x3C;</span>EOF
        <span class="token comment"># [C]</span>
        aws ecr get-login-password --region <span class="token variable">${var.aws_region}</span> <span class="token operator">|</span> docker login --username AWS --password-stdin <span class="token variable">${local.account_id}</span>.dkr.ecr.<span class="token variable">${var.aws_region}</span>.amazonaws.com

        <span class="token comment"># [D]</span>
        docker build --platform linux/amd64 -t <span class="token string">"<span class="token variable">${aws_ecr_repository.blog_terraform_docker.repository_url}</span>:latest"</span> <span class="token builtin class-name">.</span>

        <span class="token comment"># [E]</span>
        docker push <span class="token string">"<span class="token variable">${aws_ecr_repository.blog_terraform_docker.repository_url}</span>:latest"</span>
    EOF
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>Annotations of the code comments above:<br>
<strong>[A]</strong> This Terraform <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ecr_repository.html">resource</a> creates an ECR repository for storing Docker images. It includes a lifecycle policy to keep only two most recent images.
<strong>[B]</strong> The <a href="https://developer.hashicorp.com/terraform/language/resources/terraform-data">terraform_data</a> resource is not AWS-specific (or specific to any cloud provider for that matter). It depends on the ECR resource, and runs the <a href="https://developer.hashicorp.com/terraform/language/resources/provisioners/local-exec">local-exec provisioner</a> which invokes a script every time we run <code class="language-unknown">terraform apply</code>.<br>
The script runs 3 commands.<br>
<strong>[C]</strong> First, <a href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/registry_auth.html#registry-auth-token">authenticate Docker to our ECR repo</a>.<br>
<strong>[D]</strong> Second, build the docker image that assigns the image to our ECR repo URL and applies the <code class="language-unknown">latest</code> tag. Sidenote: the <code class="language-unknown">docker build</code> command here has an additional <code class="language-unknown">--platform linux/amd64</code> option, compared to the command to build the image on our local machine. I use a MacBook running on <a href="https://www.redhat.com/en/topics/linux/ARM-vs-x86">M2 chip which is based on ARM architecture, whereas EC2 free tier instances are typically based on x86 architecture</a>. Explicitly passing the <code class="language-unknown">--platform linux/amd64</code> flag ensures Docker images are compatible with x86-based EC2 instances (interesting history behind the <a href="https://en.wikipedia.org/wiki/X86-64#AMD64">amd64 nomenclature</a>).<br>
<strong>[E]</strong> Lastly, push the image to the ECR repo. Sidenote: with ECR, we can easily share Docker images across our team. After authenticating with ECR, they can pull the image to their local machines with a <strong><code class="language-unknown">docker pull</code></strong> command, referencing the repo URL and tag, and <code class="language-unknown">docker run</code> the container locally.</p>
<hr>
<h3>Step 3 - Deploy EC2 that pulls from ECR and runs Docker container</h3>
<p>To provision our EC2 instance, we need to do the following:</p>
<ul>
<li>Grant the EC2 read-only access to the ECR repo that contains our images.</li>
<li>Control the inbound and outbound network traffic to EC2.</li>
</ul>
<hr>
<h4>Grant EC2 read-only access to ECR repo</h4>
<figure>
    <img src="/images/deploy-ec2-with-ecr-docker-terraform/ec2-ecr.png">
</figure>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token comment"># [A] IAM Role for the EC2 instance to allow it to pull images from ECR.</span>
resource <span class="token string">"aws_iam_role"</span> <span class="token string">"blog_terraform_docker_ec2_role"</span> <span class="token punctuation">{</span>
  name <span class="token operator">=</span> <span class="token string">"blog-terraform-docker-ec2-role"</span>

  assume_role_policy <span class="token operator">=</span> jsonencode<span class="token punctuation">(</span><span class="token punctuation">{</span>
    Version <span class="token operator">=</span> <span class="token string">"2012-10-17"</span>,
    Statement <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        Action <span class="token operator">=</span> <span class="token string">"sts:AssumeRole"</span>,
        Effect <span class="token operator">=</span> <span class="token string">"Allow"</span>,
        Principal <span class="token operator">=</span> <span class="token punctuation">{</span>
          Service <span class="token operator">=</span> <span class="token string">"ec2.amazonaws.com"</span>,
        <span class="token punctuation">}</span>,
      <span class="token punctuation">}</span>,
    <span class="token punctuation">]</span>,
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  tags <span class="token operator">=</span> local.common_tags
<span class="token punctuation">}</span>

<span class="token comment"># [B] Policy Attachment to allow EC2 instance to communicate with ECR.</span>
resource <span class="token string">"aws_iam_role_policy_attachment"</span> <span class="token string">"blog_terraform_docker_ec2_ecr_policy"</span> <span class="token punctuation">{</span>
  role <span class="token operator">=</span> aws_iam_role.blog_terraform_docker_ec2_role.name
  policy_arn <span class="token operator">=</span> <span class="token string">"arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly"</span>
<span class="token punctuation">}</span>

<span class="token comment"># [C] Create an instance profile which will pass the role to EC2.</span>
resource <span class="token string">"aws_iam_instance_profile"</span> <span class="token string">"blog_terraform_docker_ec2_instance_profile"</span> <span class="token punctuation">{</span>
  name <span class="token operator">=</span> <span class="token string">"blog-terraform-docker-ec2-instance-profile"</span>
  role <span class="token operator">=</span> aws_iam_role.blog_terraform_docker_ec2_role.name
  tags <span class="token operator">=</span> local.common_tags
<span class="token punctuation">}</span>
</code></pre></div>
<p>Annotations of the code comments above:<br>
<strong>[A]</strong> Create an <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html">IAM role</a>, which is similar to an IAM user, in that it is an AWS identity assigned with permission policies that determine what the identity can and cannot do in AWS. But instead of being uniquely associated with one person like a user, a role is intended to be assumable by resources that need it, e.g., EC2.<br>
<strong>[B]</strong> Create a policy attachment that grants <a href="https://docs.aws.amazon.com/aws-managed-policy/latest/reference/AmazonEC2ContainerRegistryReadOnly.html#AmazonEC2ContainerRegistryReadOnly-json">read-only permissions to pull images from ECR</a>, and assigns the permissions to the role.<br>
<strong>[C]</strong> Create an <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html">instance profile</a> to pass the role to an EC2 instance. This profile will subsequently be attached to the EC2 instance.</p>
<p>If the above makes no sense, here’s a <a href="https://devopscube.com/aws-iam-role-instance-profile/">lovely article with helpful diagrams</a> to illustrate the relationship between roles, policies, profiles, and resources like EC2.</p>
<hr>
<h4>Control inbound and outbound network traffic to EC2 via Security Groups</h4>
<p>Security groups act as virtual firewalls for our cloud resources, allowing us to control the traffic that enters and exits our EC2 instances.</p>
<figure>
    <img src="/images/deploy-ec2-with-ecr-docker-terraform/ec2-sg.gif">
</figure>
<p>Each security group defines a set of rules that specify allowed traffic based on protocol, port range, and source or destination IP address. Inbound rules determine which types of connections are allowed to reach our instance, such as SSH for remote login or HTTP/HTTPS for web traffic. Outbound rules determine what types of connections the instance can initiate, allowing us to restrict communication to specific services or networks.</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token comment"># [A] Create a Security Group to allow SSH access to the instance.</span>
module <span class="token string">"dev_ssh_sg"</span> <span class="token punctuation">{</span>
  <span class="token comment"># https://registry.terraform.io/modules/terraform-aws-modules/security-group/aws/latest</span>
  <span class="token builtin class-name">source</span> <span class="token operator">=</span> <span class="token string">"terraform-aws-modules/security-group/aws"</span>

  name        <span class="token operator">=</span> <span class="token string">"dev_ssh_sg"</span>
  description <span class="token operator">=</span> <span class="token string">"Security group for SSH access"</span>
  vpc_id      <span class="token operator">=</span> local.default_vpc_id

  ingress_cidr_blocks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"YOUR.IP.HE.RE/32"</span><span class="token punctuation">]</span>
  ingress_rules       <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"ssh-tcp"</span><span class="token punctuation">]</span>

  tags <span class="token operator">=</span> local.common_tags
<span class="token punctuation">}</span>

<span class="token comment"># [B] Create a Security Group to allow HTTP access to the instance.</span>
module <span class="token string">"public_http_sg"</span> <span class="token punctuation">{</span>
  <span class="token comment"># https://registry.terraform.io/modules/terraform-aws-modules/security-group/aws/latest</span>
  <span class="token builtin class-name">source</span> <span class="token operator">=</span> <span class="token string">"terraform-aws-modules/security-group/aws"</span>

  name        <span class="token operator">=</span> <span class="token string">"public_http_sg"</span>
  description <span class="token operator">=</span> <span class="token string">"Security group for HTTP traffic"</span>
  vpc_id      <span class="token operator">=</span> local.default_vpc_id

  ingress_cidr_blocks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span>
  ingress_rules       <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"http-80-tcp"</span><span class="token punctuation">]</span>
  egress_rules        <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"all-all"</span><span class="token punctuation">]</span>

  tags <span class="token operator">=</span> local.common_tags
<span class="token punctuation">}</span>
</code></pre></div>
<p>Annotations of the code comments above:<br>
<strong>[A]</strong> Create an SG that allows inbound SSH access to resources (i.e., EC2) within our default <a href="https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html">VPC</a> via <code class="language-unknown">ingress_rules</code>. Secure SSH access by limiting it to our IP address via <code class="language-unknown">ingress_cidr_blocks</code>. Later, we will SSH into EC2 to confirm that the container is running, and examine error logs if it’s not.<br>
<strong>[B]</strong> Create an SG that allows inbound HTTP traffic on port 80 to resources (i.e., EC2) within our default <a href="https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html">VPC</a> via <code class="language-unknown">ingress_rules</code> and allow all outbound traffic via <code class="language-unknown">egress_rules</code>.</p>
<hr>
<h4>Deploy EC2</h4>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">resource <span class="token string">"aws_instance"</span> <span class="token string">"blog_terraform_docker_ec2_instance"</span> <span class="token punctuation">{</span>
  <span class="token comment"># [A]</span>
  lifecycle <span class="token punctuation">{</span>
    replace_triggered_by <span class="token operator">=</span> <span class="token punctuation">[</span>terraform_data.docker_build.id<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token comment"># [B]</span>
  <span class="token comment"># Amazon Linux 2023 AMI 2023.4.20240416.0 x86_64 HVM kernel-6.1</span>
  ami           <span class="token operator">=</span> <span class="token string">"ami-04e5276ebb8451442"</span>
  instance_type <span class="token operator">=</span> <span class="token string">"t3.micro"</span>

  <span class="token comment"># [C]</span>
  key_name      <span class="token operator">=</span> <span class="token string">"blog-terraform-docker"</span>

  <span class="token comment"># [D]</span>
  iam_instance_profile <span class="token operator">=</span> aws_iam_instance_profile.blog_terraform_docker_ec2_instance_profile.name

  <span class="token comment"># [E]</span>
  vpc_security_group_ids <span class="token operator">=</span> <span class="token punctuation">[</span>
    module.ec2_sg.security_group_id,
    module.dev_ssh_sg.security_group_id
  <span class="token punctuation">]</span>

  <span class="token comment"># [F]</span>
  user_data <span class="token operator">=</span> <span class="token operator">&#x3C;&#x3C;-</span>EOF
    <span class="token comment"># [G]</span>
    <span class="token comment">#!/bin/bash</span>
    <span class="token function">sudo</span> yum update -y
    <span class="token function">sudo</span> yum <span class="token function">install</span> -y docker
    <span class="token function">sudo</span> <span class="token function">service</span> docker start
    <span class="token function">sudo</span> <span class="token function">usermod</span> -a -G docker <span class="token variable"><span class="token variable">$(</span><span class="token function">whoami</span><span class="token variable">)</span></span>
    docker <span class="token function">ps</span>

    <span class="token comment"># [H]</span>
    <span class="token function">sudo</span> dnf <span class="token function">install</span> -y amazon-ecr-credential-helper
    <span class="token comment"># Check if ~/.docker/config.json exists</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -f ~/.docker/config.json <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
      <span class="token comment"># If not, create the file</span>
      <span class="token function">mkdir</span> -p ~/.docker
      <span class="token function">touch</span> ~/.docker/config.json
    <span class="token keyword">fi</span>
    <span class="token comment"># Update the file with the content { "credsStore": "ecr-login" }</span>
    <span class="token builtin class-name">echo</span> <span class="token string">'{ "credsStore": "ecr-login" }'</span> <span class="token operator">></span> ~/.docker/config.json

    <span class="token comment"># [I] Pull the image from ECR and run a container with it.</span>
    docker pull <span class="token variable">${aws_ecr_repository.blog_terraform_docker.repository_url}</span>:latest
    docker run -d -p <span class="token number">80</span>:3000 <span class="token variable">${aws_ecr_repository.blog_terraform_docker.repository_url}</span>:latest
  EOF

  tags <span class="token operator">=</span> local.common_tags
<span class="token punctuation">}</span>
</code></pre></div>
<p>Annotations of the code comments above:<br>
<strong>[A]</strong> For the sake of illustration, I’m destroying and re-launching a new EC2 instance every time we build and push a new Docker image to ECR.<br>
<strong>[B]</strong> For the sake of my wallet, I chose an <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html">AMI</a> and <a href="https://aws.amazon.com/ec2/instance-types/">EC2 instance type</a> that qualify for the AWS free tier.<br>
<strong>[C]</strong> Assign the key pair (see prerequisites) to the EC2 instance, which we will use to authenticate our identity to SSH into EC2. <br>
<strong>[D]</strong> Assign the IAM profile which passes to EC2 the IAM role granted with ECR read-only permission.<br>
<strong>[E]</strong> Assign the SGs that define the rules around SSH and HTTP access to EC2.<br>
<strong>[F]</strong> Pass a <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html#user-data-shell-scripts">shell script to execute at the launch of the EC2 instance</a>.<br>
The script does the following:<br>
<strong>[G]</strong> <a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/install-docker.html">A series of commands</a> to install Docker, start the Docker daemon, and grant the current user the permission to run Docker commands.<br>
<strong>[H]</strong> Install a <a href="https://github.com/awslabs/amazon-ecr-credential-helper?tab=readme-ov-file#amazon-linux-2023-al2023">credential helper</a> for the Docker daemon that makes it easier and more secure to authenticate Docker to the ECR repo.<br>
<strong>[I]</strong> Pull the <code class="language-unknown">latest</code> Docker image from the ECR repo, and start the image container. The <code class="language-unknown">-p 80:3000</code> option <a href="https://docs.docker.com/network/#published-ports">publishes a port</a> on the Docker host (port 80 exposed to the outside world) that maps to the container port (port 3000 the Dockerfile exposes).</p>
<hr>
<h3>Finally</h3>
<figure>
    <img src="/images/deploy-ec2-with-ecr-docker-terraform/final.gif">
</figure>
<p>Run these commands, and let the magic happen.</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">terraform init
terraform plan
terraform apply
</code></pre></div>
<p>After Terraform apply is complete, <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/connect-linux-inst-ssh.html">SSH into your EC2 instance</a> using our keypair (see prerequisites), and examine the logs in <code class="language-unknown">/var/log/cloud-init-output.log</code> to ensure our <code class="language-unknown">user_data</code> script ran as expected and/or to identify any issues or errors.</p>
<p>This will display the public DNS address of our EC2 when Terraform execution completes.</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">output <span class="token string">"public_dns"</span> <span class="token punctuation">{</span>
  value <span class="token operator">=</span> aws_instance.blog_terraform_docker_ec2_instance.public_dns
<span class="token punctuation">}</span>
</code></pre></div>
<p>Open up <code class="language-unknown">http://your-public-dns</code> in the browser and 🎉!</p>
<figure>
    <img src="/images/deploy-ec2-with-ecr-docker-terraform/hello-world.jpg" style="border: 1px solid black;" >
</figure>
<hr>
<figure>
    <img src="/images/deploy-ec2-with-ecr-docker-terraform/kermit-frog-exhausted.png" >
</figure>
<hr>
<h3>Resources</h3>
<ul>
<li>Here’s <a href="https://github.com/suhanw/blog-terraform-docker/tree/main">my repo</a> to see the whole thing come together.</li>
<li>Diagrams were created with <a href="http://cloudcraft.co">Cloudcraft</a>.</li>
</ul>
</div><div class="footer_2PjJq"><span class="socialIcons_2XzlR"><a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://www.suhanwijaya.com/posts/deploy-ec2-with-ecr-docker-terraform" target="_blank" aria-label="Share this article on LinkedIn"><img src="/images/linkedin-share.png"/></a><a href="https://x.com/intent/tweet?text=Deploy Docker-ized React/Node.js on EC2 via Terraform by Suhan Wijaya%20@suhanw%20https://www.suhanwijaya.com/posts/deploy-ec2-with-ecr-docker-terraform" target="_blank" aria-label="Share this article on Twitter"><img src="/images/twitter-x-share.png"/></a></span></div><div class="author_3TJVZ"><a href="https://www.linkedin.com/comm/mynetwork/discovery-see-all?usecase=PEOPLE_FOLLOWS&amp;followMember=suhanwijaya"><img src="https://github.com/suhanw.png?size=200"/></a><span>Liked what you&#x27;ve read? <br/><a href="https://www.linkedin.com/comm/mynetwork/discovery-see-all?usecase=PEOPLE_FOLLOWS&amp;followMember=suhanwijaya">Follow me on LinkedIn!</a></span></div></article><nav class="bottomMenu_SThI5"><div class="authorMobile_IHm92"><a href="https://www.linkedin.com/comm/mynetwork/discovery-see-all?usecase=PEOPLE_FOLLOWS&amp;followMember=suhanwijaya"><img src="https://github.com/suhanw.png?size=200"/></a><span>Liked what you&#x27;ve read? <br/><a href="https://www.linkedin.com/comm/mynetwork/discovery-see-all?usecase=PEOPLE_FOLLOWS&amp;followMember=suhanwijaya">Follow me on LinkedIn!</a></span></div></nav></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"deploy-ec2-with-ecr-docker-terraform","contentHtml":"\u003cp\u003eTerraform, Docker, and AWS are pivotal tools in modern software practices, enabling developers to streamline the process of deploying, managing, and scaling applications in the cloud. Here are notes from my journey in exploring the basics of Terraform, Docker, and AWS, and understanding how they work together.\u003c/p\u003e\n\u003chr\u003e\n\u003ch3\u003eBig picture\u003c/h3\u003e\n\u003cp\u003eWe will accomplish these steps:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eBuild and package our web app into a Docker image.\u003c/li\u003e\n\u003cli\u003ePush the Docker image to AWS Elastic Container Registry (ECR) which is a Docker container registry for storing container images.\u003c/li\u003e\n\u003cli\u003eDeploy an AWS Elastic Compute Cloud (EC2) instance that pulls the latest Docker image of our web app from ECR and starts our containerized web app.\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch3\u003ePrerequisites\u003c/h3\u003e\n\u003cp\u003eBefore we start, ensure you have the following:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eInstall \u003ca href=\"https://docs.docker.com/desktop/install/mac-install/\"\u003eDocker\u003c/a\u003e and \u003ca href=\"https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli\"\u003eTerraform\u003c/a\u003e on your local machine.\u003c/li\u003e\n\u003cli\u003eCreate an AWS \u003ca href=\"https://docs.aws.amazon.com/IAM/latest/UserGuide/getting-set-up.html#create-an-admin\"\u003eIdentity and Access Management (IAM) user with Admin access\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003eGenerate a \u003ca href=\"https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html#Using_CreateAccessKey\"\u003esecret access key\u003c/a\u003e for your IAM admin user to enable Terraform to interact with AWS.\u003c/li\u003e\n\u003cli\u003eGenerate an \u003ca href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/create-key-pairs.html\"\u003eEC2 key pair\u003c/a\u003e to enable you to SSH into the EC2 instance.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eAll done? Here we go!\u003c/p\u003e\n\u003chr\u003e\n\u003ch3\u003eStep 1 - Build and package our web app into a Docker image\u003c/h3\u003e\n\u003cfigure\u003e\n    \u003cimg src=\"/images/deploy-ec2-with-ecr-docker-terraform/cover.jpg\"\u003e\n\u003c/figure\u003e\n\u003cp\u003eWe will be using the React/Node.js app from this \u003ca href=\"https://www.suhanwijaya.com/posts/react-node-typescript-2024\"\u003eprevious blog post\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eRun the command \u003ccode class=\"language-unknown\"\u003edocker init\u003c/code\u003e , answer several questions, to create a templated Dockerfile in the project root directory as a starting point.\u003c/p\u003e\n\u003cp\u003eThe following Dockerfile was updated from the initial template, and it serves as a set of instructions to containerize our web app. It starts with an Alpine-based Node.js image and includes several steps to install dependencies, build the application, and set up the environment for production use:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-docker\"\u003e\u003ccode class=\"language-docker\"\u003e\u003cspan class=\"token comment\"\u003e# Dockerfile\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# syntax=docker/dockerfile:1\u003c/span\u003e\n\n\u003cspan class=\"token instruction\"\u003e\u003cspan class=\"token keyword\"\u003eARG\u003c/span\u003e NODE_VERSION=20.12.2\u003c/span\u003e\n\u003cspan class=\"token instruction\"\u003e\u003cspan class=\"token keyword\"\u003eFROM\u003c/span\u003e node:\u003cspan class=\"token variable\"\u003e${NODE_VERSION}\u003c/span\u003e-alpine\u003c/span\u003e\n\n\u003cspan class=\"token instruction\"\u003e\u003cspan class=\"token keyword\"\u003eENV\u003c/span\u003e NODE_ENV production\u003c/span\u003e\n\n\u003cspan class=\"token instruction\"\u003e\u003cspan class=\"token keyword\"\u003eWORKDIR\u003c/span\u003e /usr/src/app\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# [A]\u003c/span\u003e\n\u003cspan class=\"token instruction\"\u003e\u003cspan class=\"token keyword\"\u003eRUN\u003c/span\u003e \u003cspan class=\"token options\"\u003e\u003cspan class=\"token property\"\u003e--mount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003etype=bind,source=package.json,target=package.json\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\\\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e--mount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003etype=bind,source=package-lock.json,target=package-lock.json\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\\\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e--mount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003etype=cache,target=/root/.npm\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\\\u003c/span\u003e\n    npm ci --include=dev\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# [B]\u003c/span\u003e\n\u003cspan class=\"token instruction\"\u003e\u003cspan class=\"token keyword\"\u003eCOPY\u003c/span\u003e . .\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# [C]\u003c/span\u003e\n\u003cspan class=\"token instruction\"\u003e\u003cspan class=\"token keyword\"\u003eRUN\u003c/span\u003e npm run build\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# [D]\u003c/span\u003e\n\u003cspan class=\"token instruction\"\u003e\u003cspan class=\"token keyword\"\u003eEXPOSE\u003c/span\u003e 3000\u003c/span\u003e\n\u003cspan class=\"token instruction\"\u003e\u003cspan class=\"token keyword\"\u003eUSER\u003c/span\u003e node\u003c/span\u003e\n\u003cspan class=\"token instruction\"\u003e\u003cspan class=\"token keyword\"\u003eCMD\u003c/span\u003e npm run start\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAnnotations of the code comments above:\u003cbr\u003e\n\u003cstrong\u003e[A]\u003c/strong\u003e Install dependencies using \u003ccode class=\"language-unknown\"\u003enpm ci\u003c/code\u003e to ensure consistent builds and utilize cache mounts to improve build speed.\u003cbr\u003e\n\u003cstrong\u003e[B]\u003c/strong\u003e Copy the dependencies into the \u003ca href=\"https://docs.docker.com/reference/dockerfile/#workdir\"\u003eWORKDIR\u003c/a\u003e to build and start our web app.\u003cbr\u003e\n\u003cstrong\u003e[C]\u003c/strong\u003e Build the app!\u003cbr\u003e\n\u003cstrong\u003e[D]\u003c/strong\u003e Expose port 3000 for incoming traffic, start the app as a non-root user for security reasons, and our app will now listen on port 3000 for connections.\u003c/p\u003e\n\u003cp\u003eTo build this Docker image locally:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003edocker build \u003cspan class=\"token builtin class-name\"\u003e.\u003c/span\u003e -t my-app\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eTo run the image as a container:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003edocker run -it -p \u003cspan class=\"token number\"\u003e3000\u003c/span\u003e:3000 my-app:latest\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe \u003ccode class=\"language-unknown\"\u003e-p 3000:3000\u003c/code\u003e option \u003ca href=\"https://docs.docker.com/network/#published-ports\"\u003epublishes a port\u003c/a\u003e on the Docker host (the port accessible to the outside world) that maps to the container port (the port our Dockerfile exposes).\u003c/p\u003e\n\u003chr\u003e\n\u003ch3\u003eStep 2 - Push the Docker image to ECR\u003c/h3\u003e\n\u003cfigure\u003e\n    \u003cimg src=\"/images/deploy-ec2-with-ecr-docker-terraform/docker-ecr.gif\"\u003e\n\u003c/figure\u003e\n\u003cp\u003eNow’s the time to introduce Terraform, an infrastructure-as-code (IaC) tool to define cloud resources and manage their lifecycle. It supports various cloud providers, including AWS, enabling developers to automate infrastructure provisioning, scaling, and teardown. Terraform's declarative syntax makes it easy to describe the desired infrastructure state, and its modular structure allows for reusable code and collaboration.\u003c/p\u003e\n\u003cp\u003eBefore we delve into Terraform code, let’s first set \u003ca href=\"https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html#Using_CreateAccessKey\"\u003eour secret access key\u003c/a\u003e (see prerequisites) as environment variables to enable Terraform to interact with AWS when we run \u003ccode class=\"language-unknown\"\u003eterraform\u003c/code\u003e commands. Store these keys securely, avoid sharing them publicly. I opted to save them in a gitignored \u003ccode class=\"language-unknown\"\u003e.env\u003c/code\u003e file.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token comment\"\u003e# .env\u003c/span\u003e\n\n\u003cspan class=\"token builtin class-name\"\u003eexport\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003eAWS_ACCESS_KEY_ID\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eyour-access-key-id\n\u003cspan class=\"token builtin class-name\"\u003eexport\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003eAWS_SECRET_ACCESS_KEY\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eyour-secret-access-key\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eRun this command in the project root directory before running any \u003ccode class=\"language-unknown\"\u003eterraform\u003c/code\u003e command:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token builtin class-name\"\u003esource\u003c/span\u003e .env\n\n\u003cspan class=\"token comment\"\u003e# confirm that the env variable has been exported\u003c/span\u003e\n\u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$AWS_SECRET_ACCESS_KEY\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNow we’re ready to write some code. Terraform code lives in \u003ccode class=\"language-unknown\"\u003e.tf\u003c/code\u003e config files. For the sake of illustration, I’ll be using just a single \u003ccode class=\"language-unknown\"\u003emain.tf\u003c/code\u003e config file in the project root.\u003c/p\u003e\n\u003cp\u003eLet’s unpack the file in small chunks.\u003c/p\u003e\n\u003chr\u003e\n\u003ch4\u003eProvider configuration\u003c/h4\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token comment\"\u003e# main.tf\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# [A]\u003c/span\u003e\nterraform \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  required_providers \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    aws \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token builtin class-name\"\u003esource\u003c/span\u003e  \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"hashicorp/aws\"\u003c/span\u003e\n      version \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"~\u003e 5.0\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# [B] AWS region variable\u003c/span\u003e\nvariable \u003cspan class=\"token string\"\u003e\"aws_region\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  description \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"AWS region\"\u003c/span\u003e\n  \u003cspan class=\"token builtin class-name\"\u003etype\u003c/span\u003e        \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e string\n  default     \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"us-east-1\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# [B] AWS Provider configuration\u003c/span\u003e\nprovider \u003cspan class=\"token string\"\u003e\"aws\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# [B]\u003c/span\u003e\n  region \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e var.aws_region\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# [C] Data sources for AWS account and VPC\u003c/span\u003e\ndata \u003cspan class=\"token string\"\u003e\"aws_caller_identity\"\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"current\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\ndata \u003cspan class=\"token string\"\u003e\"aws_vpc\"\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"default\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  default \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# [C] Local variables for common information\u003c/span\u003e\nlocals \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  account_id     \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e data.aws_caller_identity.current.account_id\n  default_vpc_id \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e data.aws_vpc.default.id\n  common_tags \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    project \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"blog-terraform-docker\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAnnotations of the code comments above:\u003cbr\u003e\n\u003cstrong\u003e[A]\u003c/strong\u003e \u003ca href=\"https://developer.hashicorp.com/terraform/language/providers/configuration?utm_source=tf_registry\u0026#x26;utm_content=sidebar\"\u003eProviders\u003c/a\u003e allow Terraform to interact with cloud providers, SaaS providers, and other APIs. Therefore, Terraform configs must declare which providers they require so that Terraform can install and use them. In our case, we are declaring the AWS provider.\u003cbr\u003e\n\u003cstrong\u003e[B]\u003c/strong\u003e Specify the AWS region in which we’d like to provision our resources.\u003cbr\u003e\n\u003cstrong\u003e[C]\u003c/strong\u003e \u003ca href=\"https://developer.hashicorp.com/terraform/language/data-sources\"\u003eData sources\u003c/a\u003e allow Terraform to use information defined outside of Terraform, and each cloud provider, including AWS, offers data sources that can be used in our configs. In this case, we will be using our AWS account ID as well the \u003ca href=\"https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html\"\u003eVPC\u003c/a\u003e ID that’s provisioned by default when we signed up for the AWS account. These are saved to \u003ca href=\"https://developer.hashicorp.com/terraform/language/values/locals\"\u003elocal values\u003c/a\u003e to be used downstream in the rest of our code.\u003c/p\u003e\n\u003chr\u003e\n\u003ch4\u003eProvision an ECR repository to store our Docker images\u003c/h4\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token comment\"\u003e# [A] Create an ECR repository\u003c/span\u003e\nresource \u003cspan class=\"token string\"\u003e\"aws_ecr_repository\"\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"blog_terraform_docker\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  name \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"blog-terraform-docker\"\u003c/span\u003e\n  image_scanning_configuration \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    scan_on_push \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  tags \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e local.common_tags\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# [A] ECR lifecycle policy to retain only one untagged image preceding the latest\u003c/span\u003e\nresource \u003cspan class=\"token string\"\u003e\"aws_ecr_lifecycle_policy\"\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"blog_terraform_docker\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  repository \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e aws_ecr_repository.blog_terraform_docker.name\n  policy \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u0026#x3C;\u003c/span\u003eEOF\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token string\"\u003e\"rules\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"token string\"\u003e\"rulePriority\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e,\n          \u003cspan class=\"token string\"\u003e\"description\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Keep only one untagged image that precedes the latest image\"\u003c/span\u003e,\n          \u003cspan class=\"token string\"\u003e\"selection\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token string\"\u003e\"tagStatus\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"untagged\"\u003c/span\u003e,\n            \u003cspan class=\"token string\"\u003e\"countType\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"imageCountMoreThan\"\u003c/span\u003e,\n            \u003cspan class=\"token string\"\u003e\"countNumber\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n          \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e,\n          \u003cspan class=\"token string\"\u003e\"action\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token string\"\u003e\"type\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"expire\"\u003c/span\u003e\n          \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    EOF\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# [B] Build Docker image and push to ECR repository\u003c/span\u003e\nresource \u003cspan class=\"token string\"\u003e\"terraform_data\"\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"docker_build\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  depends_on \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eaws_ecr_repository.blog_terraform_docker\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e# To make sure the local-exec runs every time\u003c/span\u003e\n  triggers_replace \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003etimestamp\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n  provisioner \u003cspan class=\"token string\"\u003e\"local-exec\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token builtin class-name\"\u003ecommand\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u0026#x3C;\u003c/span\u003eEOF\n        \u003cspan class=\"token comment\"\u003e# [C]\u003c/span\u003e\n        aws ecr get-login-password --region \u003cspan class=\"token variable\"\u003e${var.aws_region}\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e docker login --username AWS --password-stdin \u003cspan class=\"token variable\"\u003e${local.account_id}\u003c/span\u003e.dkr.ecr.\u003cspan class=\"token variable\"\u003e${var.aws_region}\u003c/span\u003e.amazonaws.com\n\n        \u003cspan class=\"token comment\"\u003e# [D]\u003c/span\u003e\n        docker build --platform linux/amd64 -t \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e${aws_ecr_repository.blog_terraform_docker.repository_url}\u003c/span\u003e:latest\"\u003c/span\u003e \u003cspan class=\"token builtin class-name\"\u003e.\u003c/span\u003e\n\n        \u003cspan class=\"token comment\"\u003e# [E]\u003c/span\u003e\n        docker push \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e${aws_ecr_repository.blog_terraform_docker.repository_url}\u003c/span\u003e:latest\"\u003c/span\u003e\n    EOF\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAnnotations of the code comments above:\u003cbr\u003e\n\u003cstrong\u003e[A]\u003c/strong\u003e This Terraform \u003ca href=\"https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ecr_repository.html\"\u003eresource\u003c/a\u003e creates an ECR repository for storing Docker images. It includes a lifecycle policy to keep only two most recent images.\n\u003cstrong\u003e[B]\u003c/strong\u003e The \u003ca href=\"https://developer.hashicorp.com/terraform/language/resources/terraform-data\"\u003eterraform_data\u003c/a\u003e resource is not AWS-specific (or specific to any cloud provider for that matter). It depends on the ECR resource, and runs the \u003ca href=\"https://developer.hashicorp.com/terraform/language/resources/provisioners/local-exec\"\u003elocal-exec provisioner\u003c/a\u003e which invokes a script every time we run \u003ccode class=\"language-unknown\"\u003eterraform apply\u003c/code\u003e.\u003cbr\u003e\nThe script runs 3 commands.\u003cbr\u003e\n\u003cstrong\u003e[C]\u003c/strong\u003e First, \u003ca href=\"https://docs.aws.amazon.com/AmazonECR/latest/userguide/registry_auth.html#registry-auth-token\"\u003eauthenticate Docker to our ECR repo\u003c/a\u003e.\u003cbr\u003e\n\u003cstrong\u003e[D]\u003c/strong\u003e Second, build the docker image that assigns the image to our ECR repo URL and applies the \u003ccode class=\"language-unknown\"\u003elatest\u003c/code\u003e tag. Sidenote: the \u003ccode class=\"language-unknown\"\u003edocker build\u003c/code\u003e command here has an additional \u003ccode class=\"language-unknown\"\u003e--platform linux/amd64\u003c/code\u003e option, compared to the command to build the image on our local machine. I use a MacBook running on \u003ca href=\"https://www.redhat.com/en/topics/linux/ARM-vs-x86\"\u003eM2 chip which is based on ARM architecture, whereas EC2 free tier instances are typically based on x86 architecture\u003c/a\u003e. Explicitly passing the \u003ccode class=\"language-unknown\"\u003e--platform linux/amd64\u003c/code\u003e flag ensures Docker images are compatible with x86-based EC2 instances (interesting history behind the \u003ca href=\"https://en.wikipedia.org/wiki/X86-64#AMD64\"\u003eamd64 nomenclature\u003c/a\u003e).\u003cbr\u003e\n\u003cstrong\u003e[E]\u003c/strong\u003e Lastly, push the image to the ECR repo. Sidenote: with ECR, we can easily share Docker images across our team. After authenticating with ECR, they can pull the image to their local machines with a \u003cstrong\u003e\u003ccode class=\"language-unknown\"\u003edocker pull\u003c/code\u003e\u003c/strong\u003e command, referencing the repo URL and tag, and \u003ccode class=\"language-unknown\"\u003edocker run\u003c/code\u003e the container locally.\u003c/p\u003e\n\u003chr\u003e\n\u003ch3\u003eStep 3 - Deploy EC2 that pulls from ECR and runs Docker container\u003c/h3\u003e\n\u003cp\u003eTo provision our EC2 instance, we need to do the following:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eGrant the EC2 read-only access to the ECR repo that contains our images.\u003c/li\u003e\n\u003cli\u003eControl the inbound and outbound network traffic to EC2.\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch4\u003eGrant EC2 read-only access to ECR repo\u003c/h4\u003e\n\u003cfigure\u003e\n    \u003cimg src=\"/images/deploy-ec2-with-ecr-docker-terraform/ec2-ecr.png\"\u003e\n\u003c/figure\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token comment\"\u003e# [A] IAM Role for the EC2 instance to allow it to pull images from ECR.\u003c/span\u003e\nresource \u003cspan class=\"token string\"\u003e\"aws_iam_role\"\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"blog_terraform_docker_ec2_role\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  name \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"blog-terraform-docker-ec2-role\"\u003c/span\u003e\n\n  assume_role_policy \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e jsonencode\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    Version \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"2012-10-17\"\u003c/span\u003e,\n    Statement \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        Action \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"sts:AssumeRole\"\u003c/span\u003e,\n        Effect \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Allow\"\u003c/span\u003e,\n        Principal \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n          Service \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"ec2.amazonaws.com\"\u003c/span\u003e,\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e,\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e,\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e,\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n  tags \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e local.common_tags\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# [B] Policy Attachment to allow EC2 instance to communicate with ECR.\u003c/span\u003e\nresource \u003cspan class=\"token string\"\u003e\"aws_iam_role_policy_attachment\"\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"blog_terraform_docker_ec2_ecr_policy\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  role \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e aws_iam_role.blog_terraform_docker_ec2_role.name\n  policy_arn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# [C] Create an instance profile which will pass the role to EC2.\u003c/span\u003e\nresource \u003cspan class=\"token string\"\u003e\"aws_iam_instance_profile\"\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"blog_terraform_docker_ec2_instance_profile\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  name \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"blog-terraform-docker-ec2-instance-profile\"\u003c/span\u003e\n  role \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e aws_iam_role.blog_terraform_docker_ec2_role.name\n  tags \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e local.common_tags\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAnnotations of the code comments above:\u003cbr\u003e\n\u003cstrong\u003e[A]\u003c/strong\u003e Create an \u003ca href=\"https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html\"\u003eIAM role\u003c/a\u003e, which is similar to an IAM user, in that it is an AWS identity assigned with permission policies that determine what the identity can and cannot do in AWS. But instead of being uniquely associated with one person like a user, a role is intended to be assumable by resources that need it, e.g., EC2.\u003cbr\u003e\n\u003cstrong\u003e[B]\u003c/strong\u003e Create a policy attachment that grants \u003ca href=\"https://docs.aws.amazon.com/aws-managed-policy/latest/reference/AmazonEC2ContainerRegistryReadOnly.html#AmazonEC2ContainerRegistryReadOnly-json\"\u003eread-only permissions to pull images from ECR\u003c/a\u003e, and assigns the permissions to the role.\u003cbr\u003e\n\u003cstrong\u003e[C]\u003c/strong\u003e Create an \u003ca href=\"https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html\"\u003einstance profile\u003c/a\u003e to pass the role to an EC2 instance. This profile will subsequently be attached to the EC2 instance.\u003c/p\u003e\n\u003cp\u003eIf the above makes no sense, here’s a \u003ca href=\"https://devopscube.com/aws-iam-role-instance-profile/\"\u003elovely article with helpful diagrams\u003c/a\u003e to illustrate the relationship between roles, policies, profiles, and resources like EC2.\u003c/p\u003e\n\u003chr\u003e\n\u003ch4\u003eControl inbound and outbound network traffic to EC2 via Security Groups\u003c/h4\u003e\n\u003cp\u003eSecurity groups act as virtual firewalls for our cloud resources, allowing us to control the traffic that enters and exits our EC2 instances.\u003c/p\u003e\n\u003cfigure\u003e\n    \u003cimg src=\"/images/deploy-ec2-with-ecr-docker-terraform/ec2-sg.gif\"\u003e\n\u003c/figure\u003e\n\u003cp\u003eEach security group defines a set of rules that specify allowed traffic based on protocol, port range, and source or destination IP address. Inbound rules determine which types of connections are allowed to reach our instance, such as SSH for remote login or HTTP/HTTPS for web traffic. Outbound rules determine what types of connections the instance can initiate, allowing us to restrict communication to specific services or networks.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token comment\"\u003e# [A] Create a Security Group to allow SSH access to the instance.\u003c/span\u003e\nmodule \u003cspan class=\"token string\"\u003e\"dev_ssh_sg\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e# https://registry.terraform.io/modules/terraform-aws-modules/security-group/aws/latest\u003c/span\u003e\n  \u003cspan class=\"token builtin class-name\"\u003esource\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"terraform-aws-modules/security-group/aws\"\u003c/span\u003e\n\n  name        \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"dev_ssh_sg\"\u003c/span\u003e\n  description \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Security group for SSH access\"\u003c/span\u003e\n  vpc_id      \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e local.default_vpc_id\n\n  ingress_cidr_blocks \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"YOUR.IP.HE.RE/32\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  ingress_rules       \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"ssh-tcp\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n  tags \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e local.common_tags\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# [B] Create a Security Group to allow HTTP access to the instance.\u003c/span\u003e\nmodule \u003cspan class=\"token string\"\u003e\"public_http_sg\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e# https://registry.terraform.io/modules/terraform-aws-modules/security-group/aws/latest\u003c/span\u003e\n  \u003cspan class=\"token builtin class-name\"\u003esource\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"terraform-aws-modules/security-group/aws\"\u003c/span\u003e\n\n  name        \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"public_http_sg\"\u003c/span\u003e\n  description \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Security group for HTTP traffic\"\u003c/span\u003e\n  vpc_id      \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e local.default_vpc_id\n\n  ingress_cidr_blocks \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"0.0.0.0/0\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  ingress_rules       \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"http-80-tcp\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  egress_rules        \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"all-all\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n  tags \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e local.common_tags\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAnnotations of the code comments above:\u003cbr\u003e\n\u003cstrong\u003e[A]\u003c/strong\u003e Create an SG that allows inbound SSH access to resources (i.e., EC2) within our default \u003ca href=\"https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html\"\u003eVPC\u003c/a\u003e via \u003ccode class=\"language-unknown\"\u003eingress_rules\u003c/code\u003e. Secure SSH access by limiting it to our IP address via \u003ccode class=\"language-unknown\"\u003eingress_cidr_blocks\u003c/code\u003e. Later, we will SSH into EC2 to confirm that the container is running, and examine error logs if it’s not.\u003cbr\u003e\n\u003cstrong\u003e[B]\u003c/strong\u003e Create an SG that allows inbound HTTP traffic on port 80 to resources (i.e., EC2) within our default \u003ca href=\"https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html\"\u003eVPC\u003c/a\u003e via \u003ccode class=\"language-unknown\"\u003eingress_rules\u003c/code\u003e and allow all outbound traffic via \u003ccode class=\"language-unknown\"\u003eegress_rules\u003c/code\u003e.\u003c/p\u003e\n\u003chr\u003e\n\u003ch4\u003eDeploy EC2\u003c/h4\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eresource \u003cspan class=\"token string\"\u003e\"aws_instance\"\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"blog_terraform_docker_ec2_instance\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e# [A]\u003c/span\u003e\n  lifecycle \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    replace_triggered_by \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eterraform_data.docker_build.id\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e# [B]\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e# Amazon Linux 2023 AMI 2023.4.20240416.0 x86_64 HVM kernel-6.1\u003c/span\u003e\n  ami           \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"ami-04e5276ebb8451442\"\u003c/span\u003e\n  instance_type \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"t3.micro\"\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e# [C]\u003c/span\u003e\n  key_name      \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"blog-terraform-docker\"\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e# [D]\u003c/span\u003e\n  iam_instance_profile \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e aws_iam_instance_profile.blog_terraform_docker_ec2_instance_profile.name\n\n  \u003cspan class=\"token comment\"\u003e# [E]\u003c/span\u003e\n  vpc_security_group_ids \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n    module.ec2_sg.security_group_id,\n    module.dev_ssh_sg.security_group_id\n  \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e# [F]\u003c/span\u003e\n  user_data \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u0026#x3C;-\u003c/span\u003eEOF\n    \u003cspan class=\"token comment\"\u003e# [G]\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e#!/bin/bash\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e yum update -y\n    \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e yum \u003cspan class=\"token function\"\u003einstall\u003c/span\u003e -y docker\n    \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eservice\u003c/span\u003e docker start\n    \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eusermod\u003c/span\u003e -a -G docker \u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003e\u003cspan class=\"token function\"\u003ewhoami\u003c/span\u003e\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e\n    docker \u003cspan class=\"token function\"\u003eps\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e# [H]\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e dnf \u003cspan class=\"token function\"\u003einstall\u003c/span\u003e -y amazon-ecr-credential-helper\n    \u003cspan class=\"token comment\"\u003e# Check if ~/.docker/config.json exists\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!\u003c/span\u003e -f ~/.docker/config.json \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethen\u003c/span\u003e\n      \u003cspan class=\"token comment\"\u003e# If not, create the file\u003c/span\u003e\n      \u003cspan class=\"token function\"\u003emkdir\u003c/span\u003e -p ~/.docker\n      \u003cspan class=\"token function\"\u003etouch\u003c/span\u003e ~/.docker/config.json\n    \u003cspan class=\"token keyword\"\u003efi\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e# Update the file with the content { \"credsStore\": \"ecr-login\" }\u003c/span\u003e\n    \u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e'{ \"credsStore\": \"ecr-login\" }'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e ~/.docker/config.json\n\n    \u003cspan class=\"token comment\"\u003e# [I] Pull the image from ECR and run a container with it.\u003c/span\u003e\n    docker pull \u003cspan class=\"token variable\"\u003e${aws_ecr_repository.blog_terraform_docker.repository_url}\u003c/span\u003e:latest\n    docker run -d -p \u003cspan class=\"token number\"\u003e80\u003c/span\u003e:3000 \u003cspan class=\"token variable\"\u003e${aws_ecr_repository.blog_terraform_docker.repository_url}\u003c/span\u003e:latest\n  EOF\n\n  tags \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e local.common_tags\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAnnotations of the code comments above:\u003cbr\u003e\n\u003cstrong\u003e[A]\u003c/strong\u003e For the sake of illustration, I’m destroying and re-launching a new EC2 instance every time we build and push a new Docker image to ECR.\u003cbr\u003e\n\u003cstrong\u003e[B]\u003c/strong\u003e For the sake of my wallet, I chose an \u003ca href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html\"\u003eAMI\u003c/a\u003e and \u003ca href=\"https://aws.amazon.com/ec2/instance-types/\"\u003eEC2 instance type\u003c/a\u003e that qualify for the AWS free tier.\u003cbr\u003e\n\u003cstrong\u003e[C]\u003c/strong\u003e Assign the key pair (see prerequisites) to the EC2 instance, which we will use to authenticate our identity to SSH into EC2. \u003cbr\u003e\n\u003cstrong\u003e[D]\u003c/strong\u003e Assign the IAM profile which passes to EC2 the IAM role granted with ECR read-only permission.\u003cbr\u003e\n\u003cstrong\u003e[E]\u003c/strong\u003e Assign the SGs that define the rules around SSH and HTTP access to EC2.\u003cbr\u003e\n\u003cstrong\u003e[F]\u003c/strong\u003e Pass a \u003ca href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html#user-data-shell-scripts\"\u003eshell script to execute at the launch of the EC2 instance\u003c/a\u003e.\u003cbr\u003e\nThe script does the following:\u003cbr\u003e\n\u003cstrong\u003e[G]\u003c/strong\u003e \u003ca href=\"https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/install-docker.html\"\u003eA series of commands\u003c/a\u003e to install Docker, start the Docker daemon, and grant the current user the permission to run Docker commands.\u003cbr\u003e\n\u003cstrong\u003e[H]\u003c/strong\u003e Install a \u003ca href=\"https://github.com/awslabs/amazon-ecr-credential-helper?tab=readme-ov-file#amazon-linux-2023-al2023\"\u003ecredential helper\u003c/a\u003e for the Docker daemon that makes it easier and more secure to authenticate Docker to the ECR repo.\u003cbr\u003e\n\u003cstrong\u003e[I]\u003c/strong\u003e Pull the \u003ccode class=\"language-unknown\"\u003elatest\u003c/code\u003e Docker image from the ECR repo, and start the image container. The \u003ccode class=\"language-unknown\"\u003e-p 80:3000\u003c/code\u003e option \u003ca href=\"https://docs.docker.com/network/#published-ports\"\u003epublishes a port\u003c/a\u003e on the Docker host (port 80 exposed to the outside world) that maps to the container port (port 3000 the Dockerfile exposes).\u003c/p\u003e\n\u003chr\u003e\n\u003ch3\u003eFinally\u003c/h3\u003e\n\u003cfigure\u003e\n    \u003cimg src=\"/images/deploy-ec2-with-ecr-docker-terraform/final.gif\"\u003e\n\u003c/figure\u003e\n\u003cp\u003eRun these commands, and let the magic happen.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eterraform init\nterraform plan\nterraform apply\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAfter Terraform apply is complete, \u003ca href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/connect-linux-inst-ssh.html\"\u003eSSH into your EC2 instance\u003c/a\u003e using our keypair (see prerequisites), and examine the logs in \u003ccode class=\"language-unknown\"\u003e/var/log/cloud-init-output.log\u003c/code\u003e to ensure our \u003ccode class=\"language-unknown\"\u003euser_data\u003c/code\u003e script ran as expected and/or to identify any issues or errors.\u003c/p\u003e\n\u003cp\u003eThis will display the public DNS address of our EC2 when Terraform execution completes.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eoutput \u003cspan class=\"token string\"\u003e\"public_dns\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  value \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e aws_instance.blog_terraform_docker_ec2_instance.public_dns\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eOpen up \u003ccode class=\"language-unknown\"\u003ehttp://your-public-dns\u003c/code\u003e in the browser and 🎉!\u003c/p\u003e\n\u003cfigure\u003e\n    \u003cimg src=\"/images/deploy-ec2-with-ecr-docker-terraform/hello-world.jpg\" style=\"border: 1px solid black;\" \u003e\n\u003c/figure\u003e\n\u003chr\u003e\n\u003cfigure\u003e\n    \u003cimg src=\"/images/deploy-ec2-with-ecr-docker-terraform/kermit-frog-exhausted.png\" \u003e\n\u003c/figure\u003e\n\u003chr\u003e\n\u003ch3\u003eResources\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eHere’s \u003ca href=\"https://github.com/suhanw/blog-terraform-docker/tree/main\"\u003emy repo\u003c/a\u003e to see the whole thing come together.\u003c/li\u003e\n\u003cli\u003eDiagrams were created with \u003ca href=\"http://cloudcraft.co\"\u003eCloudcraft\u003c/a\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n","pin_order":12,"title":"Deploy Docker-ized React/Node.js on EC2 via Terraform","description":"Avoid ClickOps by using Terraform to push Docker images to ECR and run a container on EC2","image":"https://www.suhanwijaya.com/images/deploy-ec2-with-ecr-docker-terraform/final-preview.gif","tags":"webdev,docker,terraform,aws,ec2,ecr,react,node","date":"2024-04-25"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"deploy-ec2-with-ecr-docker-terraform"},"buildId":"2LaIplhqTpmdcbgHIhlFN","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-e3f124d20a714e6dd239.js"></script><script src="/_next/static/chunks/main-5e53dfd826fb0870df0c.js" async=""></script><script src="/_next/static/chunks/webpack-147ea3ada7109f6dc0bb.js" async=""></script><script src="/_next/static/chunks/framework.abffcf18e526b7c0dbcd.js" async=""></script><script src="/_next/static/chunks/c8817c810ac732b2202d2ab097cea034b8097b3b.0aef9695673ee5c17c2c.js" async=""></script><script src="/_next/static/chunks/styles.9f8778bb7b15c3d6357d.js" async=""></script><script src="/_next/static/chunks/pages/_app-bc363205d93151ffb13d.js" async=""></script><script src="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.56ff6c4147bf7f56cf0b.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-d0a1dfafc99629a40584.js" async=""></script><script src="/_next/static/2LaIplhqTpmdcbgHIhlFN/_buildManifest.js" async=""></script><script src="/_next/static/2LaIplhqTpmdcbgHIhlFN/_ssgManifest.js" async=""></script></body></html>