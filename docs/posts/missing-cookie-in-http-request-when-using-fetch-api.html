<!DOCTYPE html><html><head><meta charSet="utf-8"/><title>Missing cookie in HTTP request when using Fetch API by Suhan Wijaya</title><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="title" content="Missing cookie in HTTP request when using Fetch API by Suhan Wijaya"/><meta name="description"/><meta property="og:type" content="website"/><meta property="og:url" content="https://www.suhanwijaya.com/posts/missing-cookie-in-http-request-when-using-fetch-api"/><meta property="og:title" content="Missing cookie in HTTP request when using Fetch API by Suhan Wijaya"/><meta property="og:description"/><meta property="og:image"/><meta name="twitter:title" content="Missing cookie in HTTP request when using Fetch API by Suhan Wijaya"/><meta name="twitter:description"/><meta name="twitter:image"/><meta name="twitter:card" content="summary_large_image"/><link rel="canonical" href="https://medium.com/@suhanwijaya/missing-cookie-in-http-request-when-using-fetch-api-fc0199c3dc3c"/><meta name="next-head-count" content="15"/><link rel="preload" href="/_next/static/css/styles.2a357fdd.chunk.css" as="style"/><link rel="stylesheet" href="/_next/static/css/styles.2a357fdd.chunk.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-08372472a9a690b518ed.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-147ea3ada7109f6dc0bb.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.abffcf18e526b7c0dbcd.js" as="script"/><link rel="preload" href="/_next/static/chunks/e4c8223e6318a62675b83f1688c61c375db5b2bb.d4f57090bd55662b89aa.js" as="script"/><link rel="preload" href="/_next/static/chunks/styles.b52d536ba97a85102fd0.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-3f426cc9284b0d3f87e0.js" as="script"/><link rel="preload" href="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.4aea04fc80fc95b214df.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-1cc17da55ef19e625b6d.js" as="script"/></head><body><div id="__next"><div class="layout_GvkLX hasTopMenu_1WVP3"><nav class="menu_2G6rj topMenu_3pGJ_"><h2 class="name_10dbC">suhan <br/>wijaya</h2><ul class="menuItems_26ie3"><li class="menuItem_5m-L2"><a href="/#intro">INTRO</a></li><li class="menuItem_5m-L2"><a href="/#about">ABOUT</a></li><li class="menuItem_5m-L2"><a href="/#blog">BLOG</a></li><li class="menuItem_5m-L2"><a href="/#projects">PROJECTS</a></li><li class="menuItem_5m-L2"><a href="/#contact">CONTACT</a></li><li class="menuItem_5m-L2"><a href="/#technologies">TECHNOLOGIES</a></li></ul><a href="mailto:suhanw@gmail.com" target="_blank" class="email_3kN3h">suhanw@gmail.com</a><div class="social_3_hb2"><a href="https://www.linkedin.com/in/suhanwijaya/" target="_blank"><img src="/images/linked-in.png"/></a><a href="https://twitter.com/suhanw" target="_blank"><img src="/images/twitter.png"/></a><a href="https://github.com/suhanw" target="_blank"><img src="/images/github.png"/></a></div><ul class="topMenuItems_3Vx-y"><li class="menuItem_5m-L2"><a href="/#blog">BACK TO HOME</a></li></ul></nav><button class="hamburger_1KX_H"><img src="/images/hamburger.png"/></button><article class="contentWrapper_1Wy1l"><h1 class="title_29RlI">Missing cookie in HTTP request when using Fetch API</h1><div class="description_1Da_c"></div><div class="date_2avFh"><time dateTime="2020-11-02">Nov 2, 2020</time></div><div class="content_33yU5"><p><img src="https://cdn-images-1.medium.com/max/1024/1*LNmccGUYREE_8COw-QeQqQ.jpeg" alt=""><figcaption>Image source: <a href="https://programmerhumour.tumblr.com/image/630496229395218432">Programmer Humor</a></figcaption></p>
<p>Here is an <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies">explainer</a> of how cookies work. TLDR:</p>
<ul>
<li>Browser sends HTTP request to server.</li>
<li>Server sends HTTP response with <code>Set-Cookie: cookie=monster</code> header, which sets the cookie in the browser.</li>
<li>Every subsequent request the browser sends to the server will have the <code>Cookie: cookie=monster</code> header.</li>
</ul>
<p>I store a CSRF token in a cookie, which is used by the server to validate client-side HTTP <code>POST</code> requests. The server responds with a 403 if the cookie is missing in the HTTP request.</p>
<p>On the client-side, I have been using the <a href="https://github.com/lquixada/cross-fetch">cross-fetch</a> package via the <strong>ponyfill</strong> approach.</p>
<pre><code class="language-javascript">import fetch from 'cross-fetch';

fetch('/some-route', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: { /* some payload */ }
});
</code></pre>
<p>One day, I decided to switch to the <strong>polyfill</strong> approach in order to use the native <code>window.fetch</code>.</p>
<pre><code class="language-javascript">import 'cross-fetch';

fetch('/some-route', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: { /* some payload */ }
});
</code></pre>
<h3>A bunch of users started getting 403s.</h3>
<p><img src="https://cdn-images-1.medium.com/max/300/1*DNVHxZtaNDbGgbIKqEtUMQ.gif" alt=""><figcaption>Image source: <a href="https://knowyourmeme.com/photos/716245-selena-gomez-crying">Know Your Meme</a></figcaption></p>
<p>After scouring Stack Overflow and the interwebs (and many tears later), the answer was in the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">MDN docs</a> all along:</p>
<p><img src="https://cdn-images-1.medium.com/max/1024/1*bSFo0kfUKd7G4Skl96dQ-w.png" alt=""></p>
<p>The users getting 403s were using browsers older than the versions listed above. So this was the fix:</p>
<pre><code class="language-javascript">import 'cross-fetch';

fetch('/some-route', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: { /* some payload */ },
    credentials: 'same-origin' // the fix
});
</code></pre>
<p>You might ask: what about Internet Explorer, your favorite problem child? Well, since <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API#Browser_compatibility">it supports nothing</a>, the polyfill kicks in with a version of fetch that sets same-origin as the default credentials policy, so no 403s.</p>
<p>Today I learned.</p>
<p>ðŸ“« <em>Hit me up on</em> <a href="https://www.linkedin.com/in/suhanwijaya/"><em>LinkedIn</em></a> <em>or</em> <a href="https://twitter.com/suhanw"><em>Twitter</em></a><em>!</em></p>
</div><div class="footer_2PjJq"></div></article></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"missing-cookie-in-http-request-when-using-fetch-api","contentHtml":"\u003cp\u003e\u003cimg src=\"https://cdn-images-1.medium.com/max/1024/1*LNmccGUYREE_8COw-QeQqQ.jpeg\" alt=\"\"\u003e\u003cfigcaption\u003eImage source: \u003ca href=\"https://programmerhumour.tumblr.com/image/630496229395218432\"\u003eProgrammer Humor\u003c/a\u003e\u003c/figcaption\u003e\u003c/p\u003e\n\u003cp\u003eHere is an \u003ca href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies\"\u003eexplainer\u003c/a\u003e of how cookies work. TLDR:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eBrowser sends HTTP request to server.\u003c/li\u003e\n\u003cli\u003eServer sends HTTP response with \u003ccode\u003eSet-Cookie: cookie=monster\u003c/code\u003e header, which sets the cookie in the browser.\u003c/li\u003e\n\u003cli\u003eEvery subsequent request the browser sends to the server will have the \u003ccode\u003eCookie: cookie=monster\u003c/code\u003e header.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eI store a CSRF token in a cookie, which is used by the server to validate client-side HTTP \u003ccode\u003ePOST\u003c/code\u003e requests. The server responds with a 403 if the cookie is missing in the HTTP request.\u003c/p\u003e\n\u003cp\u003eOn the client-side, I have been using the \u003ca href=\"https://github.com/lquixada/cross-fetch\"\u003ecross-fetch\u003c/a\u003e package via the \u003cstrong\u003eponyfill\u003c/strong\u003e approach.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003eimport fetch from 'cross-fetch';\n\nfetch('/some-route', {\n    method: 'POST',\n    headers: {\n        'Content-Type': 'application/json'\n    },\n    body: { /* some payload */ }\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOne day, I decided to switch to the \u003cstrong\u003epolyfill\u003c/strong\u003e approach in order to use the native \u003ccode\u003ewindow.fetch\u003c/code\u003e.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003eimport 'cross-fetch';\n\nfetch('/some-route', {\n    method: 'POST',\n    headers: {\n        'Content-Type': 'application/json'\n    },\n    body: { /* some payload */ }\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eA bunch of users started getting 403s.\u003c/h3\u003e\n\u003cp\u003e\u003cimg src=\"https://cdn-images-1.medium.com/max/300/1*DNVHxZtaNDbGgbIKqEtUMQ.gif\" alt=\"\"\u003e\u003cfigcaption\u003eImage source: \u003ca href=\"https://knowyourmeme.com/photos/716245-selena-gomez-crying\"\u003eKnow Your Meme\u003c/a\u003e\u003c/figcaption\u003e\u003c/p\u003e\n\u003cp\u003eAfter scouring Stack Overflow and the interwebs (and many tears later), the answer was in the \u003ca href=\"https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API\"\u003eMDN docs\u003c/a\u003e all along:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://cdn-images-1.medium.com/max/1024/1*bSFo0kfUKd7G4Skl96dQ-w.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eThe users getting 403s were using browsers older than the versions listed above. So this was the fix:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003eimport 'cross-fetch';\n\nfetch('/some-route', {\n    method: 'POST',\n    headers: {\n        'Content-Type': 'application/json'\n    },\n    body: { /* some payload */ },\n    credentials: 'same-origin' // the fix\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou might ask: what about Internet Explorer, your favorite problem child? Well, since \u003ca href=\"https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API#Browser_compatibility\"\u003eit supports nothing\u003c/a\u003e, the polyfill kicks in with a version of fetch that sets same-origin as the default credentials policy, so no 403s.\u003c/p\u003e\n\u003cp\u003eToday I learned.\u003c/p\u003e\n\u003cp\u003eðŸ“« \u003cem\u003eHit me up on\u003c/em\u003e \u003ca href=\"https://www.linkedin.com/in/suhanwijaya/\"\u003e\u003cem\u003eLinkedIn\u003c/em\u003e\u003c/a\u003e \u003cem\u003eor\u003c/em\u003e \u003ca href=\"https://twitter.com/suhanw\"\u003e\u003cem\u003eTwitter\u003c/em\u003e\u003c/a\u003e\u003cem\u003e!\u003c/em\u003e\u003c/p\u003e\n","title":"Missing cookie in HTTP request when using Fetch API","date":"2020-11-02","tags":"coding,webdev,internet,browsers","canonical_url":"https://medium.com/@suhanwijaya/missing-cookie-in-http-request-when-using-fetch-api-fc0199c3dc3c"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"missing-cookie-in-http-request-when-using-fetch-api"},"buildId":"bCtqUlVBLqwk5n195g2Yn","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-28a453ab78bd7ac4fdb9.js"></script><script src="/_next/static/chunks/main-08372472a9a690b518ed.js" async=""></script><script src="/_next/static/chunks/webpack-147ea3ada7109f6dc0bb.js" async=""></script><script src="/_next/static/chunks/framework.abffcf18e526b7c0dbcd.js" async=""></script><script src="/_next/static/chunks/e4c8223e6318a62675b83f1688c61c375db5b2bb.d4f57090bd55662b89aa.js" async=""></script><script src="/_next/static/chunks/styles.b52d536ba97a85102fd0.js" async=""></script><script src="/_next/static/chunks/pages/_app-3f426cc9284b0d3f87e0.js" async=""></script><script src="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.4aea04fc80fc95b214df.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-1cc17da55ef19e625b6d.js" async=""></script><script src="/_next/static/bCtqUlVBLqwk5n195g2Yn/_buildManifest.js" async=""></script><script src="/_next/static/bCtqUlVBLqwk5n195g2Yn/_ssgManifest.js" async=""></script></body></html>