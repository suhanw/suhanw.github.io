{"pageProps":{"postData":{"id":"deploy-ec2-with-ecr-docker-terraform","contentHtml":"<p>Terraform, Docker, and AWS are pivotal tools in modern software practices, enabling developers to streamline the process of deploying, managing, and scaling applications in the cloud. Here are notes from my journey in exploring the basics of Terraform, Docker, and AWS, and understanding how they work together.</p>\n<hr>\n<h3>Big picture</h3>\n<p>We will accomplish these steps:</p>\n<ol>\n<li>Build and package our web app into a Docker image.</li>\n<li>Push the Docker image to AWS Elastic Container Registry (ECR) which is a Docker container registry for storing container images.</li>\n<li>Deploy an AWS Elastic Compute Cloud (EC2) instance that pulls the latest Docker image of our web app from ECR and starts our containerized web app.</li>\n</ol>\n<hr>\n<h3>Prerequisites</h3>\n<p>Before we start, ensure you have the following:</p>\n<ul>\n<li>Install <a href=\"https://docs.docker.com/desktop/install/mac-install/\">Docker</a> and <a href=\"https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli\">Terraform</a> on your local machine.</li>\n<li>Create an AWS <a href=\"https://docs.aws.amazon.com/IAM/latest/UserGuide/getting-set-up.html#create-an-admin\">Identity and Access Management (IAM) user with Admin access</a>.</li>\n<li>Generate a <a href=\"https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html#Using_CreateAccessKey\">secret access key</a> for your IAM admin user to enable Terraform to interact with AWS.</li>\n<li>Generate an <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/create-key-pairs.html\">EC2 key pair</a> to enable you to SSH into the EC2 instance.</li>\n</ul>\n<p>All done? Here we go!</p>\n<hr>\n<h3>Step 1 - Build and package our web app into a Docker image</h3>\n<figure>\n    <img src=\"/images/deploy-ec2-with-ecr-docker-terraform/cover.jpg\">\n</figure>\n<p>We will be using the React/Node.js app from this <a href=\"https://www.suhanwijaya.com/posts/react-node-typescript-2024\">previous blog post</a>.</p>\n<p>Run the command <code class=\"language-unknown\">docker init</code> , answer several questions, to create a templated Dockerfile in the project root directory as a starting point.</p>\n<p>The following Dockerfile was updated from the initial template, and it serves as a set of instructions to containerize our web app. It starts with an Alpine-based Node.js image and includes several steps to install dependencies, build the application, and set up the environment for production use:</p>\n<div class=\"remark-highlight\"><pre class=\"language-docker\"><code class=\"language-docker\"><span class=\"token comment\"># Dockerfile</span>\n<span class=\"token comment\"># syntax=docker/dockerfile:1</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> NODE_VERSION=20.12.2</span>\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> node:<span class=\"token variable\">${NODE_VERSION}</span>-alpine</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> NODE_ENV production</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /usr/src/app</span>\n\n<span class=\"token comment\"># [A]</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> <span class=\"token options\"><span class=\"token property\">--mount</span><span class=\"token punctuation\">=</span><span class=\"token string\">type=bind,source=package.json,target=package.json</span> <span class=\"token operator\">\\</span>\n    <span class=\"token property\">--mount</span><span class=\"token punctuation\">=</span><span class=\"token string\">type=bind,source=package-lock.json,target=package-lock.json</span> <span class=\"token operator\">\\</span>\n    <span class=\"token property\">--mount</span><span class=\"token punctuation\">=</span><span class=\"token string\">type=cache,target=/root/.npm</span></span> <span class=\"token operator\">\\</span>\n    npm ci --include=dev</span>\n\n<span class=\"token comment\"># [B]</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> . .</span>\n\n<span class=\"token comment\"># [C]</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> npm run build</span>\n\n<span class=\"token comment\"># [D]</span>\n<span class=\"token instruction\"><span class=\"token keyword\">EXPOSE</span> 3000</span>\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> node</span>\n<span class=\"token instruction\"><span class=\"token keyword\">CMD</span> npm run start</span>\n</code></pre></div>\n<p>Annotations of the code comments above:<br>\n<strong>[A]</strong> Install dependencies using <code class=\"language-unknown\">npm ci</code> to ensure consistent builds and utilize cache mounts to improve build speed.<br>\n<strong>[B]</strong> Copy the dependencies into the <a href=\"https://docs.docker.com/reference/dockerfile/#workdir\">WORKDIR</a> to build and start our web app.<br>\n<strong>[C]</strong> Build the app!<br>\n<strong>[D]</strong> Expose port 3000 for incoming traffic, start the app as a non-root user for security reasons, and our app will now listen on port 3000 for connections.</p>\n<p>To build this Docker image locally:</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\">docker build <span class=\"token builtin class-name\">.</span> -t my-app\n</code></pre></div>\n<p>To run the image as a container:</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\">docker run -it -p <span class=\"token number\">3000</span>:3000 my-app:latest\n</code></pre></div>\n<p>The <code class=\"language-unknown\">-p 3000:3000</code> option <a href=\"https://docs.docker.com/network/#published-ports\">publishes a port</a> on the Docker host (the port accessible to the outside world) that maps to the container port (the port our Dockerfile exposes).</p>\n<hr>\n<h3>Step 2 - Push the Docker image to ECR</h3>\n<figure>\n    <img src=\"/images/deploy-ec2-with-ecr-docker-terraform/docker-ecr.gif\">\n</figure>\n<p>Nowâ€™s the time to introduce Terraform, an infrastructure-as-code (IaC) tool to define cloud resources and manage their lifecycle. It supports various cloud providers, including AWS, enabling developers to automate infrastructure provisioning, scaling, and teardown. Terraform's declarative syntax makes it easy to describe the desired infrastructure state, and its modular structure allows for reusable code and collaboration.</p>\n<p>Before we delve into Terraform code, letâ€™s first set <a href=\"https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html#Using_CreateAccessKey\">our secret access key</a> (see prerequisites) as environment variables to enable Terraform to interact with AWS when we run <code class=\"language-unknown\">terraform</code> commands. Store these keys securely, avoid sharing them publicly. I opted to save them in a gitignored <code class=\"language-unknown\">.env</code> file.</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># .env</span>\n\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">AWS_ACCESS_KEY_ID</span><span class=\"token operator\">=</span>your-access-key-id\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">AWS_SECRET_ACCESS_KEY</span><span class=\"token operator\">=</span>your-secret-access-key\n</code></pre></div>\n<p>Run this command in the project root directory before running any <code class=\"language-unknown\">terraform</code> command:</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">source</span> .env\n\n<span class=\"token comment\"># confirm that the env variable has been exported</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token variable\">$AWS_SECRET_ACCESS_KEY</span>\n</code></pre></div>\n<p>Now weâ€™re ready to write some code. Terraform code lives in <code class=\"language-unknown\">.tf</code> config files. For the sake of illustration, Iâ€™ll be using just a single <code class=\"language-unknown\">main.tf</code> config file in the project root.</p>\n<p>Letâ€™s unpack the file in small chunks.</p>\n<hr>\n<h4>Provider configuration</h4>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># main.tf</span>\n\n<span class=\"token comment\"># [A]</span>\nterraform <span class=\"token punctuation\">{</span>\n  required_providers <span class=\"token punctuation\">{</span>\n    aws <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token builtin class-name\">source</span>  <span class=\"token operator\">=</span> <span class=\"token string\">\"hashicorp/aws\"</span>\n      version <span class=\"token operator\">=</span> <span class=\"token string\">\"~> 5.0\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># [B] AWS region variable</span>\nvariable <span class=\"token string\">\"aws_region\"</span> <span class=\"token punctuation\">{</span>\n  description <span class=\"token operator\">=</span> <span class=\"token string\">\"AWS region\"</span>\n  <span class=\"token builtin class-name\">type</span>        <span class=\"token operator\">=</span> string\n  default     <span class=\"token operator\">=</span> <span class=\"token string\">\"us-east-1\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># [B] AWS Provider configuration</span>\nprovider <span class=\"token string\">\"aws\"</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\"># [B]</span>\n  region <span class=\"token operator\">=</span> var.aws_region\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># [C] Data sources for AWS account and VPC</span>\ndata <span class=\"token string\">\"aws_caller_identity\"</span> <span class=\"token string\">\"current\"</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\ndata <span class=\"token string\">\"aws_vpc\"</span> <span class=\"token string\">\"default\"</span> <span class=\"token punctuation\">{</span>\n  default <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># [C] Local variables for common information</span>\nlocals <span class=\"token punctuation\">{</span>\n  account_id     <span class=\"token operator\">=</span> data.aws_caller_identity.current.account_id\n  default_vpc_id <span class=\"token operator\">=</span> data.aws_vpc.default.id\n  common_tags <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    project <span class=\"token operator\">=</span> <span class=\"token string\">\"blog-terraform-docker\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>Annotations of the code comments above:<br>\n<strong>[A]</strong> <a href=\"https://developer.hashicorp.com/terraform/language/providers/configuration?utm_source=tf_registry&#x26;utm_content=sidebar\">Providers</a> allow Terraform to interact with cloud providers, SaaS providers, and other APIs. Therefore, Terraform configs must declare which providers they require so that Terraform can install and use them. In our case, we are declaring the AWS provider.<br>\n<strong>[B]</strong> Specify the AWS region in which weâ€™d like to provision our resources.<br>\n<strong>[C]</strong> <a href=\"https://developer.hashicorp.com/terraform/language/data-sources\">Data sources</a> allow Terraform to use information defined outside of Terraform, and each cloud provider, including AWS, offers data sources that can be used in our configs. In this case, we will be using our AWS account ID as well the <a href=\"https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html\">VPC</a> ID thatâ€™s provisioned by default when we signed up for the AWS account. These are saved to <a href=\"https://developer.hashicorp.com/terraform/language/values/locals\">local values</a> to be used downstream in the rest of our code.</p>\n<hr>\n<h4>Provision an ECR repository to store our Docker images</h4>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># [A] Create an ECR repository</span>\nresource <span class=\"token string\">\"aws_ecr_repository\"</span> <span class=\"token string\">\"blog_terraform_docker\"</span> <span class=\"token punctuation\">{</span>\n  name <span class=\"token operator\">=</span> <span class=\"token string\">\"blog-terraform-docker\"</span>\n  image_scanning_configuration <span class=\"token punctuation\">{</span>\n    scan_on_push <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span>\n  tags <span class=\"token operator\">=</span> local.common_tags\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># [A] ECR lifecycle policy to retain only one untagged image preceding the latest</span>\nresource <span class=\"token string\">\"aws_ecr_lifecycle_policy\"</span> <span class=\"token string\">\"blog_terraform_docker\"</span> <span class=\"token punctuation\">{</span>\n  repository <span class=\"token operator\">=</span> aws_ecr_repository.blog_terraform_docker.name\n  policy <span class=\"token operator\">=</span> <span class=\"token operator\">&#x3C;&#x3C;</span>EOF\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"rules\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"rulePriority\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,\n          <span class=\"token string\">\"description\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Keep only one untagged image that precedes the latest image\"</span>,\n          <span class=\"token string\">\"selection\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"tagStatus\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"untagged\"</span>,\n            <span class=\"token string\">\"countType\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"imageCountMoreThan\"</span>,\n            <span class=\"token string\">\"countNumber\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>\n          <span class=\"token punctuation\">}</span>,\n          <span class=\"token string\">\"action\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"type\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"expire\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n    EOF\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># [B] Build Docker image and push to ECR repository</span>\nresource <span class=\"token string\">\"terraform_data\"</span> <span class=\"token string\">\"docker_build\"</span> <span class=\"token punctuation\">{</span>\n  depends_on <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>aws_ecr_repository.blog_terraform_docker<span class=\"token punctuation\">]</span>\n\n  <span class=\"token comment\"># To make sure the local-exec runs every time</span>\n  triggers_replace <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>timestamp<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n\n  provisioner <span class=\"token string\">\"local-exec\"</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin class-name\">command</span> <span class=\"token operator\">=</span> <span class=\"token operator\">&#x3C;&#x3C;</span>EOF\n        <span class=\"token comment\"># [C]</span>\n        aws ecr get-login-password --region <span class=\"token variable\">${var.aws_region}</span> <span class=\"token operator\">|</span> docker login --username AWS --password-stdin <span class=\"token variable\">${local.account_id}</span>.dkr.ecr.<span class=\"token variable\">${var.aws_region}</span>.amazonaws.com\n\n        <span class=\"token comment\"># [D]</span>\n        docker build --platform linux/amd64 -t <span class=\"token string\">\"<span class=\"token variable\">${aws_ecr_repository.blog_terraform_docker.repository_url}</span>:latest\"</span> <span class=\"token builtin class-name\">.</span>\n\n        <span class=\"token comment\"># [E]</span>\n        docker push <span class=\"token string\">\"<span class=\"token variable\">${aws_ecr_repository.blog_terraform_docker.repository_url}</span>:latest\"</span>\n    EOF\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>Annotations of the code comments above:<br>\n<strong>[A]</strong> This Terraform <a href=\"https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ecr_repository.html\">resource</a> creates an ECR repository for storing Docker images. It includes a lifecycle policy to keep only two most recent images.\n<strong>[B]</strong> The <a href=\"https://developer.hashicorp.com/terraform/language/resources/terraform-data\">terraform_data</a> resource is not AWS-specific (or specific to any cloud provider for that matter). It depends on the ECR resource, and runs the <a href=\"https://developer.hashicorp.com/terraform/language/resources/provisioners/local-exec\">local-exec provisioner</a> which invokes a script every time we run <code class=\"language-unknown\">terraform apply</code>.<br>\nThe script runs 3 commands.<br>\n<strong>[C]</strong> First, <a href=\"https://docs.aws.amazon.com/AmazonECR/latest/userguide/registry_auth.html#registry-auth-token\">authenticate Docker to our ECR repo</a>.<br>\n<strong>[D]</strong> Second, build the docker image that assigns the image to our ECR repo URL and applies the <code class=\"language-unknown\">latest</code> tag. Sidenote: the <code class=\"language-unknown\">docker build</code> command here has an additional <code class=\"language-unknown\">--platform linux/amd64</code> option, compared to the command to build the image on our local machine. I use a MacBook running on <a href=\"https://www.redhat.com/en/topics/linux/ARM-vs-x86\">M2 chip which is based on ARM architecture, whereas EC2 free tier instances are typically based on x86 architecture</a>. Explicitly passing the <code class=\"language-unknown\">--platform linux/amd64</code> flag ensures Docker images are compatible with x86-based EC2 instances (interesting history behind the <a href=\"https://en.wikipedia.org/wiki/X86-64#AMD64\">amd64 nomenclature</a>).<br>\n<strong>[E]</strong> Lastly, push the image to the ECR repo. Sidenote: with ECR, we can easily share Docker images across our team. After authenticating with ECR, they can pull the image to their local machines with a <strong><code class=\"language-unknown\">docker pull</code></strong> command, referencing the repo URL and tag, and <code class=\"language-unknown\">docker run</code> the container locally.</p>\n<hr>\n<h3>Step 3 - Deploy EC2 that pulls from ECR and runs Docker container</h3>\n<p>To provision our EC2 instance, we need to do the following:</p>\n<ul>\n<li>Grant the EC2 read-only access to the ECR repo that contains our images.</li>\n<li>Control the inbound and outbound network traffic to EC2.</li>\n</ul>\n<hr>\n<h4>Grant EC2 read-only access to ECR repo</h4>\n<figure>\n    <img src=\"/images/deploy-ec2-with-ecr-docker-terraform/ec2-ecr.png\">\n</figure>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># [A] IAM Role for the EC2 instance to allow it to pull images from ECR.</span>\nresource <span class=\"token string\">\"aws_iam_role\"</span> <span class=\"token string\">\"blog_terraform_docker_ec2_role\"</span> <span class=\"token punctuation\">{</span>\n  name <span class=\"token operator\">=</span> <span class=\"token string\">\"blog-terraform-docker-ec2-role\"</span>\n\n  assume_role_policy <span class=\"token operator\">=</span> jsonencode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    Version <span class=\"token operator\">=</span> <span class=\"token string\">\"2012-10-17\"</span>,\n    Statement <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        Action <span class=\"token operator\">=</span> <span class=\"token string\">\"sts:AssumeRole\"</span>,\n        Effect <span class=\"token operator\">=</span> <span class=\"token string\">\"Allow\"</span>,\n        Principal <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n          Service <span class=\"token operator\">=</span> <span class=\"token string\">\"ec2.amazonaws.com\"</span>,\n        <span class=\"token punctuation\">}</span>,\n      <span class=\"token punctuation\">}</span>,\n    <span class=\"token punctuation\">]</span>,\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  tags <span class=\"token operator\">=</span> local.common_tags\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># [B] Policy Attachment to allow EC2 instance to communicate with ECR.</span>\nresource <span class=\"token string\">\"aws_iam_role_policy_attachment\"</span> <span class=\"token string\">\"blog_terraform_docker_ec2_ecr_policy\"</span> <span class=\"token punctuation\">{</span>\n  role <span class=\"token operator\">=</span> aws_iam_role.blog_terraform_docker_ec2_role.name\n  policy_arn <span class=\"token operator\">=</span> <span class=\"token string\">\"arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># [C] Create an instance profile which will pass the role to EC2.</span>\nresource <span class=\"token string\">\"aws_iam_instance_profile\"</span> <span class=\"token string\">\"blog_terraform_docker_ec2_instance_profile\"</span> <span class=\"token punctuation\">{</span>\n  name <span class=\"token operator\">=</span> <span class=\"token string\">\"blog-terraform-docker-ec2-instance-profile\"</span>\n  role <span class=\"token operator\">=</span> aws_iam_role.blog_terraform_docker_ec2_role.name\n  tags <span class=\"token operator\">=</span> local.common_tags\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>Annotations of the code comments above:<br>\n<strong>[A]</strong> Create an <a href=\"https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html\">IAM role</a>, which is similar to an IAM user, in that it is an AWS identity assigned with permission policies that determine what the identity can and cannot do in AWS. But instead of being uniquely associated with one person like a user, a role is intended to be assumable by resources that need it, e.g., EC2.<br>\n<strong>[B]</strong> Create a policy attachment that grants <a href=\"https://docs.aws.amazon.com/aws-managed-policy/latest/reference/AmazonEC2ContainerRegistryReadOnly.html#AmazonEC2ContainerRegistryReadOnly-json\">read-only permissions to pull images from ECR</a>, and assigns the permissions to the role.<br>\n<strong>[C]</strong> Create an <a href=\"https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html\">instance profile</a> to pass the role to an EC2 instance. This profile will subsequently be attached to the EC2 instance.</p>\n<p>If the above makes no sense, hereâ€™s a <a href=\"https://devopscube.com/aws-iam-role-instance-profile/\">lovely article with helpful diagrams</a> to illustrate the relationship between roles, policies, profiles, and resources like EC2.</p>\n<hr>\n<h4>Control inbound and outbound network traffic to EC2 via Security Groups</h4>\n<p>Security groups act as virtual firewalls for our cloud resources, allowing us to control the traffic that enters and exits our EC2 instances.</p>\n<figure>\n    <img src=\"/images/deploy-ec2-with-ecr-docker-terraform/ec2-sg.gif\">\n</figure>\n<p>Each security group defines a set of rules that specify allowed traffic based on protocol, port range, and source or destination IP address. Inbound rules determine which types of connections are allowed to reach our instance, such as SSH for remote login or HTTP/HTTPS for web traffic. Outbound rules determine what types of connections the instance can initiate, allowing us to restrict communication to specific services or networks.</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># [A] Create a Security Group to allow SSH access to the instance.</span>\nmodule <span class=\"token string\">\"dev_ssh_sg\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\"># https://registry.terraform.io/modules/terraform-aws-modules/security-group/aws/latest</span>\n  <span class=\"token builtin class-name\">source</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"terraform-aws-modules/security-group/aws\"</span>\n\n  name        <span class=\"token operator\">=</span> <span class=\"token string\">\"dev_ssh_sg\"</span>\n  description <span class=\"token operator\">=</span> <span class=\"token string\">\"Security group for SSH access\"</span>\n  vpc_id      <span class=\"token operator\">=</span> local.default_vpc_id\n\n  ingress_cidr_blocks <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"YOUR.IP.HE.RE/32\"</span><span class=\"token punctuation\">]</span>\n  ingress_rules       <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"ssh-tcp\"</span><span class=\"token punctuation\">]</span>\n\n  tags <span class=\"token operator\">=</span> local.common_tags\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># [B] Create a Security Group to allow HTTP access to the instance.</span>\nmodule <span class=\"token string\">\"public_http_sg\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\"># https://registry.terraform.io/modules/terraform-aws-modules/security-group/aws/latest</span>\n  <span class=\"token builtin class-name\">source</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"terraform-aws-modules/security-group/aws\"</span>\n\n  name        <span class=\"token operator\">=</span> <span class=\"token string\">\"public_http_sg\"</span>\n  description <span class=\"token operator\">=</span> <span class=\"token string\">\"Security group for HTTP traffic\"</span>\n  vpc_id      <span class=\"token operator\">=</span> local.default_vpc_id\n\n  ingress_cidr_blocks <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span>\n  ingress_rules       <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"http-80-tcp\"</span><span class=\"token punctuation\">]</span>\n  egress_rules        <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"all-all\"</span><span class=\"token punctuation\">]</span>\n\n  tags <span class=\"token operator\">=</span> local.common_tags\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>Annotations of the code comments above:<br>\n<strong>[A]</strong> Create an SG that allows inbound SSH access to resources (i.e., EC2) within our default <a href=\"https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html\">VPC</a> via <code class=\"language-unknown\">ingress_rules</code>. Secure SSH access by limiting it to our IP address via <code class=\"language-unknown\">ingress_cidr_blocks</code>. Later, we will SSH into EC2 to confirm that the container is running, and examine error logs if itâ€™s not.<br>\n<strong>[B]</strong> Create an SG that allows inbound HTTP traffic on port 80 to resources (i.e., EC2) within our default <a href=\"https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html\">VPC</a> via <code class=\"language-unknown\">ingress_rules</code> and allow all outbound traffic via <code class=\"language-unknown\">egress_rules</code>.</p>\n<hr>\n<h4>Deploy EC2</h4>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\">resource <span class=\"token string\">\"aws_instance\"</span> <span class=\"token string\">\"blog_terraform_docker_ec2_instance\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\"># [A]</span>\n  lifecycle <span class=\"token punctuation\">{</span>\n    replace_triggered_by <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>terraform_data.docker_build.id<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\"># [B]</span>\n  <span class=\"token comment\"># Amazon Linux 2023 AMI 2023.4.20240416.0 x86_64 HVM kernel-6.1</span>\n  ami           <span class=\"token operator\">=</span> <span class=\"token string\">\"ami-04e5276ebb8451442\"</span>\n  instance_type <span class=\"token operator\">=</span> <span class=\"token string\">\"t3.micro\"</span>\n\n  <span class=\"token comment\"># [C]</span>\n  key_name      <span class=\"token operator\">=</span> <span class=\"token string\">\"blog-terraform-docker\"</span>\n\n  <span class=\"token comment\"># [D]</span>\n  iam_instance_profile <span class=\"token operator\">=</span> aws_iam_instance_profile.blog_terraform_docker_ec2_instance_profile.name\n\n  <span class=\"token comment\"># [E]</span>\n  vpc_security_group_ids <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    module.ec2_sg.security_group_id,\n    module.dev_ssh_sg.security_group_id\n  <span class=\"token punctuation\">]</span>\n\n  <span class=\"token comment\"># [F]</span>\n  user_data <span class=\"token operator\">=</span> <span class=\"token operator\">&#x3C;&#x3C;-</span>EOF\n    <span class=\"token comment\"># [G]</span>\n    <span class=\"token comment\">#!/bin/bash</span>\n    <span class=\"token function\">sudo</span> yum update -y\n    <span class=\"token function\">sudo</span> yum <span class=\"token function\">install</span> -y docker\n    <span class=\"token function\">sudo</span> <span class=\"token function\">service</span> docker start\n    <span class=\"token function\">sudo</span> <span class=\"token function\">usermod</span> -a -G docker <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">whoami</span><span class=\"token variable\">)</span></span>\n    docker <span class=\"token function\">ps</span>\n\n    <span class=\"token comment\"># [H]</span>\n    <span class=\"token function\">sudo</span> dnf <span class=\"token function\">install</span> -y amazon-ecr-credential-helper\n    <span class=\"token comment\"># Check if ~/.docker/config.json exists</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token operator\">!</span> -f ~/.docker/config.json <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n      <span class=\"token comment\"># If not, create the file</span>\n      <span class=\"token function\">mkdir</span> -p ~/.docker\n      <span class=\"token function\">touch</span> ~/.docker/config.json\n    <span class=\"token keyword\">fi</span>\n    <span class=\"token comment\"># Update the file with the content { \"credsStore\": \"ecr-login\" }</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'{ \"credsStore\": \"ecr-login\" }'</span> <span class=\"token operator\">></span> ~/.docker/config.json\n\n    <span class=\"token comment\"># [I] Pull the image from ECR and run a container with it.</span>\n    docker pull <span class=\"token variable\">${aws_ecr_repository.blog_terraform_docker.repository_url}</span>:latest\n    docker run -d -p <span class=\"token number\">80</span>:3000 <span class=\"token variable\">${aws_ecr_repository.blog_terraform_docker.repository_url}</span>:latest\n  EOF\n\n  tags <span class=\"token operator\">=</span> local.common_tags\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>Annotations of the code comments above:<br>\n<strong>[A]</strong> For the sake of illustration, Iâ€™m destroying and re-launching a new EC2 instance every time we build and push a new Docker image to ECR.<br>\n<strong>[B]</strong> For the sake of my wallet, I chose an <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html\">AMI</a> and <a href=\"https://aws.amazon.com/ec2/instance-types/\">EC2 instance type</a> that qualify for the AWS free tier.<br>\n<strong>[C]</strong> Assign the key pair (see prerequisites) to the EC2 instance, which we will use to authenticate our identity to SSH into EC2.Â <br>\n<strong>[D]</strong> Assign the IAM profile which passes to EC2 the IAM role granted with ECR read-only permission.<br>\n<strong>[E]</strong> Assign the SGs that define the rules around SSH and HTTP access to EC2.<br>\n<strong>[F]</strong> Pass a <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html#user-data-shell-scripts\">shell script to execute at the launch of the EC2 instance</a>.<br>\nThe script does the following:<br>\n<strong>[G]</strong> <a href=\"https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/install-docker.html\">A series of commands</a> to install Docker, start the Docker daemon, and grant the current user the permission to run Docker commands.<br>\n<strong>[H]</strong> Install a <a href=\"https://github.com/awslabs/amazon-ecr-credential-helper?tab=readme-ov-file#amazon-linux-2023-al2023\">credential helper</a> for the Docker daemon that makes it easier and more secure to authenticate Docker to the ECR repo.<br>\n<strong>[I]</strong> Pull the <code class=\"language-unknown\">latest</code> Docker image from the ECR repo, and start the image container. The <code class=\"language-unknown\">-p 80:3000</code> option <a href=\"https://docs.docker.com/network/#published-ports\">publishes a port</a> on the Docker host (port 80 exposed to the outside world) that maps to the container port (port 3000 the Dockerfile exposes).</p>\n<hr>\n<h3>Finally</h3>\n<figure>\n    <img src=\"/images/deploy-ec2-with-ecr-docker-terraform/final.gif\">\n</figure>\n<p>Run these commands, and let the magic happen.</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\">terraform init\nterraform plan\nterraform apply\n</code></pre></div>\n<p>After Terraform apply is complete, <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/connect-linux-inst-ssh.html\">SSH into your EC2 instance</a> using our keypair (see prerequisites), and examine the logs in <code class=\"language-unknown\">/var/log/cloud-init-output.log</code> to ensure our <code class=\"language-unknown\">user_data</code> script ran as expected and/or to identify any issues or errors.</p>\n<p>This will display the public DNS address of our EC2 when Terraform execution completes.</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\">output <span class=\"token string\">\"public_dns\"</span> <span class=\"token punctuation\">{</span>\n  value <span class=\"token operator\">=</span> aws_instance.blog_terraform_docker_ec2_instance.public_dns\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>Open up <code class=\"language-unknown\">http://your-public-dns</code> in the browser and ðŸŽ‰!</p>\n<figure>\n    <img src=\"/images/deploy-ec2-with-ecr-docker-terraform/hello-world.jpg\" style=\"border: 1px solid black;\" >\n</figure>\n<hr>\n<figure>\n    <img src=\"/images/deploy-ec2-with-ecr-docker-terraform/kermit-frog-exhausted.png\" >\n</figure>\n<hr>\n<h3>Resources</h3>\n<ul>\n<li>Hereâ€™s <a href=\"https://github.com/suhanw/blog-terraform-docker/tree/main\">my repo</a> to see the whole thing come together.</li>\n<li>Diagrams were created with <a href=\"http://cloudcraft.co\">Cloudcraft</a>.</li>\n</ul>\n","pin_order":12,"title":"Deploy Docker-ized React/Node.js on EC2 via Terraform","description":"Avoid ClickOps by using Terraform to push Docker images to ECR and run a container on EC2","image":"https://www.suhanwijaya.com/images/deploy-ec2-with-ecr-docker-terraform/final-preview.gif","tags":"webdev,docker,terraform,aws,ec2,ecr,react,node","date":"2024-04-25"}},"__N_SSG":true}